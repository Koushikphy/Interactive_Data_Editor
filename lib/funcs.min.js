const fs=require("fs"),path=require("path"),url=require("url");var editorWindow,compFName,undoStack=[],redoStack=[],viewer=[,,],show=!1,saved=!0,firstSave=!0,issame=!1,fullData=[],fullDataCols=[],fileNames=[],saveNames=[],legendNames=[];function updateData(){if(col.x=xCol.selectedIndex,col.y=yCol.selectedIndex,col.z=zCol.selectedIndex,th_in=0,ddd){$slider.slider({max:data.length-1,value:0}),$ch.text(xName+"="+data[0][col.x][0]);var e=[];for(let t of data)e.push(t[col.x][0].toString().length);$ch.width(Math.floor(Math.max(...e)/2+2)*em2px)}else col.z=col.y,col.y=col.x,col.x=0;if(fullDataCols[0]=JSON.parse(JSON.stringify(col)),updatePlot(1),makeRows(),startDragBehavior(),updateOnServer(),!swapped)if(ddd)localStorage.setItem("cols3d",JSON.stringify(col));else{var t={x:col.y,y:col.z,z:0,s:0};localStorage.setItem("cols2d",JSON.stringify(t))}}function fileLoader(){const e=dialog.showOpenDialog({defaultPath:recentLocation,properties:["openFile"]});void 0!==e&&fileReader(e[0])}function fileReader(e){if(!saved)var t=dialog.showMessageBox({type:"warning",title:"Unsaved data found!!!",message:"There are some modified data, that you haven't saved yet.\n Are you sure to open a new file without saving?",buttons:["Yes","No"]});if(!t){swapped=0,refdat=0,xName="X",issame=!1,firstSave=!0,swapper=!1,undoStack=[],redoStack=[],fullData=[],fullDataCols=[],fileNames=[],saveNames=[],legendNames=[],swapperIsOn=!1,$("#sCol, #sColInp").hide(),$("#particle").remove(),window.pJSDom instanceof Array&&window.pJSDom[0].pJS.fn.vendors.destroypJS(),$("#full").show(),$("#jsoneditor").height(window.innerHeight-jsoneditor.offsetTop),2==figurecontainer.data.length&&Plotly.deleteTraces(figurecontainer,1),"any"!=figurecontainer.layout.selectdirection&&Plotly.relayout(figurecontainer,{selectdirection:"any"}),xCol=document.getElementById("xCol"),yCol=document.getElementById("yCol"),menu.getMenuItemById("pax").visible=!0,menu.getMenuItemById("pay").visible=!1,menu.getMenuItemById("swapen").visible=!0;for(let e of["pax","wire","surf"])menu.getMenuItemById(e).enabled=!1;var a=path.dirname(e),l=path.basename(e,path.extname(e)),o=path.extname(e);path.join(a,l+"_new"+o),recentLocation=a,localStorage.setItem("recent",JSON.stringify(recentLocation)),data=parseData(data=fs.readFileSync(e,"utf8")),ddd=1!=data.length,document.title="Interactive Data Editor - "+replaceWithHome(e);var n,i=["save","saveas","tfd","tfs","spr","pamh","swapen","edat","fill","filter","af","arf"];if(ddd)$(".3D").show(),null!==(n=JSON.parse(localStorage.getItem("cols3d")))&&(col=n),i.push("pax","wire","surf");else serve=0,$(".3D").hide(),null!==(n=JSON.parse(localStorage.getItem("cols2d")))&&(col=n);for(var s="",r=1;r<=data[0].length;r++)s+="<option>"+r+"</option>";for(let e of $("#xCol, #yCol, #zCol, #sCol"))e.innerHTML=s;for(let e of i)menu.getMenuItemById(e).enabled=!0;xCol.selectedIndex=col.x,yCol.selectedIndex=col.y,zCol.selectedIndex=col.z,sCol.selectedIndex=col.s,fullDataCols.push(JSON.parse(JSON.stringify(col))),fullData.push(data),fileNames.push(e);a=path.dirname(e),l=path.basename(e,path.extname(e)),o=path.extname(e);var d=path.join(a,l+"_new"+o);saveNames.push(d),legendNames.push(path.basename(fileNames[0])+` ${col.y+1}:${col.z+1}`),updateData(),makeEditable(),makeRows(),Plotly.restyle(figurecontainer,{name:legendNames[0]}),recentFiles=recentFiles.filter(t=>t!=e),recentFiles.push(e),recentMenu(),$ch.text(xName+"="+data[th_in][col.x][0]),$("#drag").html((e,t)=>t.replace("Y","X")),resizePlot(),showStatus("Data file loaded ...")}}function addNewFileDialog(){if(swapperIsOn)dialog.showMessageBox({type:"warning",title:"Can't add the file!!!",message:"Plot along X before adding a new file.",buttons:["Ok"]});else{var e=dialog.showOpenDialog({defaultPath:recentLocation,properties:["openFile"]});void 0!==e&&addNewFile(e[0])}}function addNewFile(e){if(layout.showlegend=!0,data=parseData(fs.readFileSync(e,"utf8")),fullData[0].length==data.length){var t=path.dirname(e),a=path.basename(e,path.extname(e)),l=path.extname(e),o=path.join(t,a+"_new"+l);fullData.unshift(data),fullDataCols.unshift(JSON.parse(JSON.stringify(col))),fileNames.unshift(e),saveNames.unshift(o),legendNames.unshift(path.basename(fileNames[0])+` ${fullDataCols[0].y+1}:${fullDataCols[0].z+1}`),addTrace(),document.title="Interactive Data Editor - "+replaceWithHome(e),recentFiles=recentFiles.filter(t=>t!=e),recentFiles.push(e),recentMenu()}else dialog.showMessageBox({type:"warning",title:"Can't add the file!!!",message:"Trying to open a file with different grid.\nThis is not supported for 3D data.",buttons:["Ok"]})}function addTrace(){figurecontainer.data.length;let e=JSON.parse(JSON.stringify(iniPointsC));e.name=legendNames[0],e.x=fullData[0][th_in][fullDataCols[0].y],e.y=fullData[0][th_in][fullDataCols[0].z],Plotly.addTraces(figurecontainer,e,0),marker=[{symbol:200,color:"#b00",size:6,opacity:1}],line=[{width:2,color:"#1e77b4",dash:0,shape:"linear"}];for(let e=1;e<figurecontainer.data.length;e++)marker.push({symbol:200,color:colorList[e%9],size:6,opacity:1}),line.push({width:2,color:colorList[e%9],dash:0,shape:"linear"});col=fullDataCols[0],Plotly.restyle(figurecontainer,{line:line,marker:marker}),makeRows(),makeEditable(),firstSave=!0,undoStack=[],redoStack=[]}function updatePlot(e=!0){dpsy=data[th_in][col.z];var t=[dpsx=data[th_in][col.y]],a=[dpsy],l=[legendNames[0]];if(swapperIsOn)Plotly.restyle(figurecontainer,{x:[data[th_in][col.y],data[th_in][col.y]],y:[data[th_in][col.z],data[th_in][col.s]]});else if(e){for(let e=1;e<fullData.length;e++)t.push(fullData[e][th_in][fullDataCols[e].y]),a.push(fullData[e][th_in][fullDataCols[e].z]),l.push(legendNames[e]);Plotly.restyle(figurecontainer,{x:t,y:a,name:l})}else Plotly.restyle(figurecontainer,{x:t,y:a,name:l},0);for(var o=0;o<dpsx.length;o++)points[o].handle={x:dpsx[o],y:dpsy[o]}}function selectEditable(e){if(swapperIsOn)[col.s,col.z]=[col.z,col.s],sCol.selectedIndex=col.s,zCol.selectedIndex=col.z,Plotly.restyle(figurecontainer,{x:[data[th_in][col.y],data[th_in][col.y]],y:[data[th_in][col.z],data[th_in][col.s]]});else{if(e>=fullData.length)return;[fullData[0],fullData[e]]=[fullData[e],fullData[0]],[fullDataCols[0],fullDataCols[e]]=[fullDataCols[e],fullDataCols[0]],[fileNames[0],fileNames[e]]=[fileNames[e],fileNames[0]],[saveNames[0],saveNames[e]]=[saveNames[e],saveNames[0]],[legendNames[0],legendNames[e]]=[legendNames[e],legendNames[0]],data=fullData[0],col=fullDataCols[0],updatePlot(),makeRows()}firstSave=!0,makeEditable(),undoStack=[],redoStack=[]}function makeEditable(){ddd?(xCol.selectedIndex=col.x,yCol.selectedIndex=col.y,zCol.selectedIndex=col.z,sCol.selectedIndex=col.s):(xCol.selectedIndex=col.y,yCol.selectedIndex=col.z,sCol.selectedIndex=col.s),pointscontainer=figurecontainer.querySelector(".scatterlayer .trace:first-of-type .points"),points=pointscontainer.getElementsByTagName("path"),data=fullData[0],dpsy=data[th_in][col.z],dpsx=data[th_in][col.y],Plotly.restyle(figurecontainer,{x:[dpsx],y:[dpsy]},0);for(var e=0;e<dpsx.length;e++)points[e].handle={x:dpsx[e],y:dpsy[e]};startDragBehavior(),document.title="Interactive Data Editor - "+replaceWithHome(fileNames[0])}document.ondragover=document.ondrop=(e=>{e.preventDefault()}),document.body.ondrop=(e=>{const t=e.dataTransfer.files[0].path;void 0!==t&&fileReader(t),e.preventDefault()});var oldX,oldCord,indd,swapperIsOn=!1;function openSwapper(){swapperIsOn=!0,$("#sCol").show(),col.s=sCol.selectedIndex;let e=figurecontainer.data.length;if(e>2){let t=[];for(let a=2;a<e;a++)t.push(a);Plotly.deleteTraces(figurecontainer,t)}else if(1==e){let e=JSON.parse(JSON.stringify(iniPointsD));e.line.color=e.marker.color=colorList[1],Plotly.addTraces(figurecontainer,e)}let t=path.basename(fileNames[0]);Plotly.restyle(figurecontainer,{x:[data[th_in][col.y],data[th_in][col.y]],y:[data[th_in][col.z],data[th_in][col.s]],name:[t+` ${col.y+1}:${col.z+1}`,t+` ${col.y+1}:${col.s+1}`]}),Plotly.relayout(figurecontainer,{selectdirection:"h"}),menu.getMenuItemById("af").enabled=!1,menu.getMenuItemById("arf").enabled=!1,$("#files").addClass("disabled"),updateJSON()}function exitSwapper(){swapperIsOn=!1,Plotly.deleteTraces(figurecontainer,[0,1]);let e=[JSON.parse(JSON.stringify(iniPointsC))];for(let t=1;t<fullData.length;t++){let a=JSON.parse(JSON.stringify(iniPointsC));a.line.color=a.marker.color=colorList[t%9],e.push(a)}Plotly.addTraces(figurecontainer,e),data=fullData[0],Plotly.relayout(figurecontainer,{selectdirection:"any"}),$("#sCol, #sColInp").hide(),updatePlot(all=!0),makeEditable(),updateJSON(),menu.getMenuItemById("af").enabled=!0,menu.getMenuItemById("arf").enabled=!0,$("#files").removeClass("disabled")}function transpose(e){return e[0].map((t,a)=>e.map(e=>e[a]))}function parseData(e){var t=[],a=[];e=e.trim().split(/\t\t\t|\r?\n\r?\n/);for(let o of e){a=o.trim().split("\n");for(var l=0;l<a.length;l++)a[l]=a[l].trim().split(/[\s\t]+/),a[l]=a[l].map(e=>parseFloat(e));t.push(transpose(a))}return t}function expRotate(e,t,a){if(e=e.map(e=>transpose(e)),!issame){issame=!0;var l=e[0].length;for(let t of e)if(t.length!=l){issame=!1;break}}if(issame)return e=(e=transpose(e)).map(e=>transpose(e));e=[].concat(...e).filter(e=>void 0!==e);var o=new Set;for(let a of e)o.add(a[t]);o=[...o].sort((e,t)=>e-t);var n=[];for(let l of o){var i=[];for(let a of e)l==a[t]&&i.push(a);i=i.sort((e,t)=>e[a]-t[a]),n.push(transpose(i))}return n}function saveAs(){var e=dialog.showSaveDialog({title:"Save As:",defaultPath:saveNames[0]});void 0!==e&&(saveNames[0]=e,saveData(),firstSave=!1)}function saveData(){e=data,swapped&&(e=expRotate(e,col.y,col.x));var e=e.map(e=>transpose(e)),t="";try{for(let a of e){for(let e of a)void 0!==e&&(t+=e.map(e=>parseFloat(e).toFixed(8)).join("\t")+"\n");t+="\n"}fs.writeFileSync(saveNames[0],t),showStatus("Data Saved in file "+replaceWithHome(saveNames[0])),saved=!0}catch(e){return showStatus("Something went wrong! Couldn't save the data..."),!1}}function isswap(){if(!data.length)return;for(let e=0;e<fullData.length;e++)[fullDataCols[e].x,fullDataCols[e].y]=[fullDataCols[e].y,fullDataCols[e].x],fullData[e]=expRotate(fullData[e],fullDataCols[e].x,fullDataCols[e].y);if(!fullData.every(e=>e.length===fullData[0].length)){for(let e=0;e<fullData.length;e++)[fullDataCols[e].x,fullDataCols[e].y]=[fullDataCols[e].y,fullDataCols[e].x],fullData[e]=expRotate(fullData[e],fullDataCols[e].x,fullDataCols[e].y);return dialog.showMessageBox({type:"warning",title:"Can't Plot along Y!!!",message:"File(s) have different grid points along the Y axis\nFree version doesn't allow plotting such data",buttons:["Ok"]}),!1}swapped=!swapped;var[e,t]=["Y","X"];swapped&&([e,t]=[t,e]),xName=t,[xCol,yCol]=[yCol,xCol],data=fullData[0],col=fullDataCols[0],updateData(),th_in=0,$slider.slider("value",0),$ch.text(xName+"="+data[th_in][col.x][0]),$("#drag").html((a,l)=>l.replace(e,t))}function sliderChanged(){$("#custom-handle").blur(),$slider.slider("value",th_in),$ch.text(xName+"="+data[th_in][col.x][0]),startDragBehavior(),updatePlot()}function colsChanged(e){col.s=e,updatePlot();let t=path.basename(fileNames[0]);Plotly.restyle(figurecontainer,{name:[t+` ${col.y}:${col.z}`,t+` ${col.y}:${col.s}`]}),swapped||localStorage.setItem("cols3d",JSON.stringify(col))}function colChanged(e){$("select").blur(),fullDataCols[0].z=col.z=e,legendNames[0]=path.basename(fileNames[0])+` ${col.y+1}:${col.z+1}`,updatePlot(all=!1),updateOnServer(),startDragBehavior(),makeRows(),swapped||localStorage.setItem("cols3d",JSON.stringify(col))}function resizePlot(){setTimeout(function(){var e=window.innerHeight-document.getElementById("header").offsetTop-document.getElementById("figurecontainer").offsetTop;$("#figurecontainer").height(e-2),Plotly.relayout(figurecontainer,{autosize:!0})},330)}function sSwapper(){[col.s,col.z]=[col.z,col.s],sCol.selectedIndex=col.s,zCol.selectedIndex=col.z,updatePlot(),updateOnServer()}function selectEvent(e){if(index=[],del_dat=[],void 0==e)Plotly.restyle(figurecontainer,{selectedpoints:[null]});else{for(let t of e.points)ind=dpsx.findIndex(e=>e==t.x),dpsy[ind]==t.y&&index.push(ind);index=[...new Set(index)]}}function updateFigure(){var e=[],t=[];if(lockXc){for(let t of points)e.push(t.handle.y);Plotly.restyle(figurecontainer,{y:[e]},0),dpsy=data[th_in][col.z]=e}else{for(let a of points)t.push(a.handle.x),e.push(a.handle.y);Plotly.restyle(figurecontainer,{x:[t],y:[e]},0),dpsy=data[th_in][col.z]=e,dpsx=data[th_in][col.y]=t}}function clamp(e,t,a){return Math.max(t,Math.min(e,a))}function startDragBehavior(){var e=Plotly.d3,t=e.behavior.drag();t.origin(function(){saveOldData();var t=e.select(this).attr("transform"),a=t.substring(10,t.length-1).split(/,| /);return index.length&&(oldCord=dpsy,indd=(oldX=dpsx).indexOf(this.handle.x)),{x:a[0],y:a[1]}}),t.on("drag",function(){var t=e.event.x,a=e.event.y;e.select(this).attr("transform","translate("+[t,a]+")");var l=this.handle,o=figurecontainer._fullLayout.yaxis;if(l.y=clamp(o.p2l(a),o.range[0],o.range[1]),index.length){var n=l.y-oldCord[indd];for(let e of index)points[e].handle.y=n+oldCord[e]}if(!lockXc){var i=figurecontainer._fullLayout.xaxis;if(l.x=clamp(i.p2l(t),i.range[0],i.range[1]),index.length){n=l.x-oldX[indd];for(let e of index)points[e].handle.x=n+oldX[e]}}updateFigure()}),t.on("dragend",function(){updateFigure(),fullData[0]=data,updatePlot(all=!1),updateOnServer(),e.select(".scatterlayer .trace:first-of-type .points path:first-of-type").call(t)}),e.selectAll(".scatterlayer .trace:first-of-type .points path").call(t)}function keyBoardDrag(e){if(index.length){ma&&(saveOldData(),ma=0);var t=figurecontainer._fullLayout.yaxis,a=t.p2l(1)-t.p2l(0);e&&(a=-a);for(let e of index)points[e].handle.y+=a;updateFigure()}}function saveOldData(){data.length&&(redoStack=[],olddata=JSON.stringify([th_in,col,swapped,data[th_in]]),10==undoStack.length&&undoStack.splice(0,1),undoStack.push(olddata),saved=!1)}function reDo(){redoStack.length&&(olddata=redoStack.pop(),undoStack.push(JSON.stringify([th_in,col,swapped,data[th_in]])),doIt())}function unDo(){ma||(ma=1),undoStack.length&&(olddata=undoStack.pop(),redoStack.push(JSON.stringify([th_in,col,swapped,data[th_in]])),doIt())}function doIt(){var e,t;[th_in,col,t,e]=JSON.parse(olddata),t!=swapped&&isswap(),zCol.selectedIndex=col.z,sCol.selectedIndex=col.s,data[th_in]=e,updatePlot(all=!1),startDragBehavior(),updateOnServer(),saved=!1}function updateOnServer(){if(serve){var e=[],t=[],a=[];for(let l of data)e.push(l[col.x]),t.push(l[col.y]),a.push(l[col.z]);var l=[e,t,a];for(let e in viewer)viewer[e].webContents.send("sdata",[l,swapped,Object.values(col)])}}var copyVar,TOAST={toast:null,_id:0,time:null,init:function(e={}){this.toast=document.createElement("div"),this.toast.id="__TOAST",this.decoration="#8393c0",this.background="rgb(52, 53, 73)",this.color="white",this.time=4e3,Object.assign(this.toast.style,{position:"absolute",top:"0",right:"0",width:"100%",height:"100%",zIndex:"99999",pointerEvents:"none",paddingRight:"3px",paddingBottom:"3px",paddingTop:"3px",borderRadius:"3px",padding:"3px",overflow:"hidden",display:"flex",flexDirection:"column",justifyContent:"flex-end",alignItems:"flex-end"});var t=document.querySelector("body");t.insertBefore(this.toast,t.firstChild)},close:function(e){e.classList.add("toastOut"),setTimeout(function(){e.remove()},250)},add:function(e,t){t||(t=this.time);var a=this,l=8*e.length+100,o=document.createElement("div");return Object.assign(o.style,{width:`${l}`,padding:"10px",minHeight:"10px",backgroundColor:this.background,color:"white",float:"right",borderRadius:"3px",boxShadow:"0 1px 19px 0px rgba(0, 0, 0, 0.45)",paddingRight:"50px",position:"relative",marginBottom:"3px",display:"flex",alignItems:"center",color:this.color,transition:"all 250ms ease",opacity:"0",transform:"scale(0.7)",fontFamily:"sans-serif"}),o.innerHTML=`\n            <p style="margin:0;">${e}</p>\n            <div onclick="TOAST.close(this.parentNode);" style="\n                position:absolute;\n                right:0;\n                top:0;\n                width:50px;\n                height:100%;\n                padding-top:3px;\n                padding-bottom:3px;\n                pointer-events: all;\n                cursor: pointer;\n            ">\n                <div style="\n                    display:flex;\n                    justify-content:center;\n                    align-items:center;\n                    width:100%;\n                    height:100%;\n                    border-left-style: solid;\n                    border-width: 1px;\n                    font-family: monospace;\n                    font-size: 1em;\n                    border-color: ${this.decoration};\n                    color: ${this.decoration};\n                ">\n                    X\n                </div>\n            </div>\n        `,this.toast.appendChild(o),setTimeout(function(){a.close(o)},t),o}};function showStatus(e){var t=TOAST.add(e,4321);setTimeout(function(){t.classList.add("toastIn")},50),$(t).width(8*e.length+5)}function copyThis(){copyVar=JSON.stringify(data[th_in])}function pasteThis(){saveOldData();var e=JSON.parse(copyVar);for(let t=0;t<e.length;t++)t!=col.x&&(data[th_in][t]=e[t]);updatePlot(1),updateOnServer(),saved=!1,startDragBehavior()}function swapData(){if(index.length){saveOldData();for(let e of index)[data[th_in][col.z][e],data[th_in][col.s][e]]=[data[th_in][col.s][e],data[th_in][col.z][e]];updatePlot(),updateOnServer()}}function repeatMirror(){var e=parseFloat($("#einp").val()),t=parseFloat($("#etime").val()),a=$("#repSel")[0].selectedIndex,l=[],o=data[0].length;for(let e=0;e<o;e++)e!=col.y&&l.push(e);for(let t=0;t<data.length;t++)if(!(data[0][col.y].indexOf(e)+1))return alert("Endpoint must exist !!!"),void $("#extend").slideUp();data=data.map(o=>{var n=o[col.y].indexOf(e)+1,i=o[col.y].slice(0,n);(r=i.slice()).splice(0,1);for(let a=0;a<t-1;a++)for(let t=0;t<r.length;t++)i.push(r[t]+e*(1+a));for(let e of l){var s=o[e].slice(0,n),r=s.slice();for(let e=0;e<t-1;e++)ptmp=a?r.reverse().slice():r.slice(),ptmp.splice(0,1),s.push(...ptmp);o[e]=s}return o[col.y]=i,o}),$("#extend").slideUp(),resizePlot(),updatePlot(),showStatus(`Data ${o=a?"mirrored":"repeated"} ${t} times...`),startDragBehavior(),updateOnServer(),saved=!1,fullData[0]=data}function dataFiller(){var e=parseFloat($("#fstart").val()),t=parseFloat($("#fend").val()),l=parseFloat($("#fstep").val()),o=[],s=data[0].length;for(let e=0;e<s;e++)e!=col.y&&o.push(e);var r=[];for(let a=e;a<=t;a+=l)r.push(a);data=data.map(e=>{if(r.length==e[0].length)return e;var t=e[col.y].slice(),l=e[col.y].length-1;for(let c of o){newArr=[];var s=e[c].slice();n=t.length,diff=new Array(n).fill(0),u=new Array(n).fill(0);for(let e=1;e<n-1;e++)sig=(t[e]-t[e-1])/(t[e+1]-t[e-1]),p=sig*diff[e-1]+2,diff[e]=(sig-1)/p,u[e]=(6*((s[e+1]-s[e])/(t[e+1]-t[e])-(s[e]-s[e-1])/(t[e]-t[e-1]))/(t[e+1]-t[e-1])-sig*u[e-1])/p;for(let e=n-2;e>-1;e-=1)diff[e]=diff[e]*diff[e+1]+u[e];function d(e){for(i=0;e>t[i];)i++;return i--,h=t[i+1]-t[i],a=(t[i+1]-e)/h,b=(e-t[i])/h,y=a*s[i]+b*s[i+1]+((a**3-a)*diff[i]+(b**3-b)*diff[i+1])*h**2/6,y}for(let t of r)ind=e[col.y].indexOf(t),-1!=ind?newArr.push(e[c][ind]):t<=e[col.y][0]?newArr.push(e[c][0]):t>=e[col.y][l]?newArr.push(e[c][l]):newArr.push(d(t));e[c]=newArr}return e[col.y]=r,e}),$("#filler").slideUp(),resizePlot(),updatePlot(),showStatus("Missing values are filled..."),startDragBehavior(),updateOnServer(),saved=!1,fullData[0]=data}function filterData(){var e=$("#flSel")[0].selectedIndex,t=parseFloat($("#flc").val()),a=parseFloat($("#flf").val()),l=$("#flcl").val().split(",").map(e=>parseFloat(e)-1);0==e?data=data.map(e=>{for(let o of l)e[o]=e[o].map(e=>e<t?a:e);return e}):1==e?data=data.map(e=>{for(let o of l)e[o]=e[o].map(e=>e>t?a:e);return e}):2==e&&(data=data.map(e=>{for(let o of l)e[o]=e[o].map(e=>e==t?a:e);return e})),$("#filter").slideUp(),resizePlot(),updatePlot(),showStatus("Data filtered..."),startDragBehavior(),updateOnServer(),saved=!1,fullData[0]=data}function determinant(e,t,a,l,o,n,i,s,r){return e*o*r-e*n*s-t*l*r+t*i*n+a*l*s-a*o*i}function deleteExtrapolate(){if(index.length){first=index[0],last=index[index.length-1],xs=dpsx.slice(Math.max(first-3,0),first).concat(dpsx.slice(last+1,last+4)),ys=dpsy.slice(Math.max(first-3,0),first).concat(dpsy.slice(last+1,last+4)),a=b=c=d=e=m=n=p=0,a=xs.length;for(let t=0;t<a;t++)b+=xs[t],c+=xs[t]**2,d+=xs[t]**3,e+=xs[t]**4,m+=ys[t],n+=ys[t]*xs[t],p+=ys[t]*xs[t]**2;det=determinant(a,b,c,b,c,d,c,d,e),c0=determinant(m,b,c,n,c,d,p,d,e)/det,c1=determinant(a,m,c,b,n,d,c,p,e)/det,c2=determinant(a,b,m,b,c,n,c,d,p)/det,saveOldData();for(let e of index)data[th_in][col.z][e]=(t=data[th_in][col.y][e],c0+c1*t+c2*t**2);var t;updatePlot(),updateOnServer(),saved=!1,fullData[0]=data}}function deleteInterpolate(){if(index.length){var e=dpsx.slice(),t=dpsy.slice();0==index[0]&&index.splice(0,1),index[index.length-1]==dpsx.length-1&&index.splice(-1,1);for(var l=index.length-1;l>=0;l--)e.splice(index[l],1),t.splice(index[l],1);n=e.length,diff=new Array(n).fill(0),u=new Array(n).fill(0);for(let a=1;a<n-1;a++)sig=(e[a]-e[a-1])/(e[a+1]-e[a-1]),p=sig*diff[a-1]+2,diff[a]=(sig-1)/p,u[a]=(6*((t[a+1]-t[a])/(e[a+1]-e[a])-(t[a]-t[a-1])/(e[a]-e[a-1]))/(e[a+1]-e[a-1])-sig*u[a-1])/p;for(let e=n-2;e>-1;e-=1)diff[e]=diff[e]*diff[e+1]+u[e];saveOldData();for(let e of index)data[th_in][col.z][e]=o(data[th_in][col.y][e]);updatePlot(),updateOnServer(),saved=!1,fullData[0]=data}function o(o){for(l=0;o>e[l];)l++;return l--,h=e[l+1]-e[l],a=(e[l+1]-o)/h,b=(o-e[l])/h,y=a*t[l]+b*t[l+1]+((a**3-a)*diff[l]+(b**3-b)*diff[l+1])*h**2/6,y}}function autoSmooth(){if(ma&&(saveOldData(),ma=0),index.length){0==index[0]&&index.splice(0,1),index[index.length-1]==dpsx.length-1&&index.splice(-1,1);for(let e of index)dpsy[e]=(dpsy[e-1]+dpsy[e]+dpsy[e+1])/3;data[th_in][col.z]=dpsy,updatePlot(),fullData[0]=data,saved=!1}}function changeSign(){if(index.length){saveOldData();for(let e of index)data[th_in][col.z][e]*=-1;updatePlot(),updateOnServer(),index=[],Plotly.restyle(figurecontainer,{selectedpoints:[null]}),saved=!1}}function hotDKeys(e){if("text"!=document.activeElement.type)switch(e.key){case"m":case"ArrowDown":case"ArrowUp":ma=1,updateOnServer()}}function hotKeys(e){if("text"!=document.activeElement.type)switch(e.key){case" ":Plotly.relayout(figurecontainer,{"xaxis.autorange":!0,"yaxis.autorange":!0});break;case",":if(0==th_in)break;th_in-=1,sliderChanged();break;case".":if(th_in==data.length-1)break;th_in+=1,sliderChanged();break;case"s":case"S":e.ctrlKey||Plotly.relayout(figurecontainer,{dragmode:"select"});break;case"z":case"Z":e.ctrlKey&!e.shiftKey?unDo():e.ctrlKey&e.shiftKey?reDo():Plotly.relayout(figurecontainer,{dragmode:"zoom"});break;case"p":case"P":swapData();break;case"d":case"D":deleteInterpolate();break;case"e":case"E":deleteExtrapolate();break;case"m":case"M":autoSmooth();break;case"c":case"C":e.ctrlKey?copyThis():changeSign();break;case"v":case"V":e.ctrlKey&&pasteThis();break;case"ArrowDown":keyBoardDrag(0);break;case"ArrowUp":keyBoardDrag(1);break;case"o":case"O":app.isPackaged||sSwapper();break;case"Tab":e.ctrlKey&&(keepTrackIndex+=1,keepTrackIndex==fullData.length&&(console.log(keepTrackIndex),keepTrackIndex=1),selectEditable(keepTrackIndex))}}TOAST.init(),ipcRenderer.on("rf",function(e,t){fileReader(t)}),ipcRenderer.on("adrf",function(e,t){addNewFile(t)}),ipcRenderer.on("back",function(e,t){data=t.map(e=>transpose(e)),updatePlot(1),startDragBehavior(),updateOnServer()}),ipcRenderer.on("checkClose",function(e,t){if(!saved)var a=dialog.showMessageBox({type:"warning",title:"Unsaved data found!!!",message:"There are some modified data, that you haven't saved yet.\n Are you sure to quit without saving?",buttons:["Yes","No"]});a||ipcRenderer.send("checkClose","closeIt")}),ipcRenderer.on("menuTrigger",function(e,t){switch(show&&console.log(e,t),t){case"open":fileLoader();break;case"add":addNewFileDialog();break;case"save":firstSave?saveAs():saveData();break;case"saveas":saveAs();break;case"wire":openViewer(0);break;case"surface":openViewer(1);break;case"spread":spreadsheet();break;case"pa":isswap();break;case"pamh":lockXc=menu.getMenuItemById("pamh").checked?1:0;break;case"fullscreen":resizePlot();break;case"tswap":swapperIsOn?exitSwapper():openSwapper();break;case"edat":$("#extend").slideDown(),resizePlot();break;case"fill":$("#filler").slideDown(),resizePlot();break;case"filter":$("#filter").slideDown(),resizePlot();break;case"pdash":$("#sidebar2").width()?closeNav2():openNav2();break;case"fdash":$("#sidebar").width()?closeNav():openNav()}}),keepTrackIndex=0,$(window).keydown(hotKeys),$(window).keyup(hotDKeys);var minWidth=window.innerWidth/4.5;function openNav(){closeNav2(),$("#split-bar").css("width",5),$("#sidebar").css("width",minWidth),$("#full").css("margin-left",minWidth+6),$(".ham").toggle(),resizePlot()}function closeNav(){$("#split-bar").css("width",0),$("#sidebar").css("width",0),$("#full").css("margin-left",0),$(".ham").toggle(),resizePlot()}function openNav2(){closeNav(),$("#split-bar2").css("width",5),$("#sidebar2").css("width",minWidth),$("#jsoneditor").css("width",minWidth-5),$("#full").css("margin-left",minWidth+6),$(".ham").toggle(),resizePlot()}function closeNav2(){$("#split-bar2").css("width",0),$("#sidebar2").css("width",0),$("#full").css("margin-left",0),$("#jsoneditor").css("width",195),$(".ham").toggle(),resizePlot()}function updateJSON(){var e=[],t=[],a=[];for(let l of figurecontainer.data)e.push(l.name),t.push(l.marker),a.push(l.line);lines={Title:e,Markers:t,Line:a},layout=figurecontainer.layout,editor.update({lines:lines,layout:layout})}$("#split-bar").mousedown(function(e){e.preventDefault(),$(document).mousemove(function(e){e.preventDefault();var t=e.pageX-$("#sidebar").offset().left;t>minWidth/5&&t<window.innerWidth/2.5&&($("#sidebar").css("width",t-2),$("#full").css("margin-left",t),minWidth=t,resizePlot())})}),$("#split-bar2").mousedown(function(e){e.preventDefault(),$(document).mousemove(function(e){e.preventDefault();var t=e.pageX-$("#sidebar2").offset().left;t>minWidth/5&&t<window.innerWidth/2.5&&($("#sidebar2").css("width",t-2),$("#full").css("margin-left",t),$("#jsoneditor").css("width",t-7),minWidth=t,resizePlot())})}),$(document).mouseup(function(e){$(document).unbind("mousemove")});var symbols=[];for(let e=0;e<=44;e++)symbols.push(e.toString()),symbols.push((e+100).toString()),symbols.push((e+200).toString());var schema={properties:{lines:{properties:{Line:{items:{properties:{width:{type:"integer"},dash:{type:"integer"},shape:{enum:["linear","spline"]}}}},Markers:{items:{properties:{symbol:{type:"integer"},size:{type:"number"},opacity:{type:"number"}}}}}}}},options={onChangeJSON:function(e){legendNames=e.lines.Title,Plotly.restyle(figurecontainer,{name:e.lines.Title,marker:e.lines.Markers,line:e.lines.Line}),Plotly.relayout(figurecontainer,e.layout),makeRows()},onColorPicker:function(e,t,a){new JSONEditor.VanillaPicker({parent:e,color:t,popup:"bottom",onChange:function(e){var t=1===e.rgba[3]?e.hex.substr(0,7):e.hex;a(t)}}).show()},mode:"form",schema:schema},jsoneditor=document.getElementById("jsoneditor"),editor=new JSONEditor(jsoneditor,options,{lines:"",layout:""});function getInd(e){selectEditable($("li").index(e))}function removeRow(e){if(1!=fullData.length){index=$(".closefile").index(e),fullData.splice(index,1),fullDataCols.splice(index,1),fileNames.splice(index,1),saveNames.splice(index,1),legendNames.splice(index,1),Plotly.deleteTraces(figurecontainer,index),makeRows(),makeEditable();var t=fullDataCols[0];if(ddd?(xCol.selectedIndex=t.x,yCol.selectedIndex=t.y,zCol.selectedIndex=t.z):(xCol.selectedIndex=t.y,yCol.selectedIndex=t.z),0==index){marker=[{symbol:200,color:"#b00",size:6,opacity:1}],line=[{width:2,color:"#1e77b4",dash:0,shape:"linear"}];for(let e=1;e<figurecontainer.data.length;e++)marker.push({symbol:200,color:colorList[e%9],size:6,opacity:1}),line.push({width:2,color:colorList[e%9],dash:0,shape:"linear"});t=fullDataCols[0],Plotly.restyle(figurecontainer,{line:line,marker:marker})}}}function copyFile(e){index=$(".copyfile").index(e),data=fullData[index],fullData.unshift(fullData[index]),fullDataCols.unshift(JSON.parse(JSON.stringify(fullDataCols[index]))),fileNames.unshift(fileNames[index]),saveNames.unshift(saveNames[index]),legendNames.unshift(legendNames[index]),addTrace()}function makeRows(){tmp="<ol>";for(let e=0;e<fileNames.length;e++)name=fileNames[e],ccll=fullDataCols[e],name=path.basename(name),tmp+=`<li onclick='getInd(this)'>\n        <input type="button" title="Close this File" class = 'closefile' value="X">\n        <input type="button" title="Copy this File" class = 'copyfile' value="C">\n        <label class='filename' >${name} ${ccll.y+1}:${ccll.z+1}</label>\n        </li>`;tmp+="</ol>",$("#files").html(tmp),$("li .closefile").click(function(e){removeRow(this),e.stopPropagation()}),$("li .copyfile").click(function(e){copyFile(this),e.stopPropagation()}),updateJSON()}function spreadsheet(){(editorWindow=new BrowserWindow({minWidth:1200,show:!1,webPreferences:{nodeIntegration:!0}})).maximize(),editorWindow.loadURL(url.format({pathname:path.join(__dirname,"handtable.html"),protocol:"file:",slashes:!0})),editorWindow.setMenuBarVisibility(!1),editorWindow.show(),app.isPackaged||editorWindow.webContents.openDevTools(),editorWindow.webContents.once("dom-ready",function(){editorWindow.webContents.send("slider",[xName,col.x,data])})}function openViewer(e){serve=1;var t="3D_Viewer_Lines.html";e&&(t="3D_Viewer_Surface.html"),viewerWindow=new BrowserWindow({show:!1,minWidth:1200,webPreferences:{nodeIntegration:!0}}),viewerWindow.maximize(),setTimeout(function(){viewerWindow.loadURL(url.format({pathname:path.join(__dirname,t),protocol:"file:",slashes:!0}))},50),viewerWindow.on("closed",function(){delete viewer[t]}),viewerWindow.show(),viewerWindow.setMenuBarVisibility(!1),viewer[t]=viewerWindow,app.isPackaged||viewerWindow.webContents.openDevTools(),viewerWindow.webContents.once("dom-ready",function(){updateOnServer()})}$("#jsoneditor").height(window.innerHeight-jsoneditor.offsetTop);var file,points,pointscontainer,data=[],compdata=[],olddata="",dpsx=[],dpsy=[],dpsy2=[],index=[],del_dat=[],th_in=0,refdat=1,ma=1,serve=0,lockXc=1,swapped=0,swapper=!1,ddd=!1,col={x:0,y:0,z:0,s:0},xName="X",$slider=$("#slider"),xCol=document.getElementById("xCol"),yCol=document.getElementById("yCol"),zCol=document.getElementById("zCol"),sCol=document.getElementById("sCol"),xVal=document.getElementById("x_val"),figurecontainer=document.getElementById("figurecontainer");$ch=$("#custom-handle");var layout={autosize:!0,plot_bgcolor:"#e8ebef",paper_bgcolor:"#fff",showlegend:!1,hovermode:"closest",title:"",margin:{t:25,r:0,b:19,l:10,pad:0},xaxis:{title:"",zeroline:!1,showline:!0,showgrid:!0,automargin:!0},yaxis:{title:"",automargin:!0,zeroline:!1,showline:!0,tickformat:" ,.5g",hoverformat:" ,.6g",showgrid:!0},font:{size:14},showlegend:!0,legend:{x:0,y:1}},colorList=["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf"],iniPointsD={x:[1],y:[1],type:"scatter",opacity:1,mode:"markers+lines",marker:{symbol:200,color:"#b00",size:6,opacity:1},line:{width:2,color:"#1e77b4",dash:0,shape:"linear"},hoverinfo:"x+y"},iniPointsC={x:[1],y:[1],type:"scatter",opacity:1,mode:"markers+lines",marker:{symbol:200,color:"#b00",size:6,opacity:1},line:{width:2,color:"#1e77b4",dash:0,shape:"linear"},hoverinfo:"x+y"};const Plotly=require("plotly.js-gl3d-dist");Plotly.newPlot(figurecontainer,[iniPointsD],layout,{displaylogo:!1,modeBarButtonsToRemove:["sendDataToCloud"],editable:!0}),pointscontainer=figurecontainer.querySelector(".scatterlayer .trace:first-of-type .points"),points=pointscontainer.getElementsByTagName("path"),figurecontainer.on("plotly_selected",selectEvent),figurecontainer.on("plotly_relayout",updateJSON),resizePlot(),$(function(){$slider.slider({min:0,max:0,step:1,slide:function(e,t){th_in=t.value,sliderChanged()}})});var em2px=$ch.width()/3;