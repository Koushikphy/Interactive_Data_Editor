var fname,figurecontainer=document.getElementById("figurecontainer"),data=[],ranges=[],zCols=[],recentLocation="";const Plotly=require("plotly.js-gl3d-dist"),fs=require("fs"),{ipcRenderer:ipcRenderer,remote:remote,shell:shell,Menu:Menu}=require("electron"),path=require("path"),{dialog:dialog}=remote;ipcRenderer.on("checkClose",function(e,t){ipcRenderer.send("checkClose","closeIt")}),$("#imRes").val("1500x2000");var trace={type:"surface",hoverinfo:"x+y+z",colorscale:"Portland",opacity:1,hoverlabel:{bgcolor:"#2ca02c"},z:[[1]],x:[[1]],y:[[1]],showscale:!1,cmin:0,cmax:0,cauto:!0,colorbar:{thickness:30,dtick:1,len:1,x:1.02,xpad:10,y:.5,ypad:10,tickfont:{family:"Times New Roman",size:20}},contours:{x:{show:!1,highlight:!0,start:0,end:0,size:1,color:"#000",usecolormap:!1,width:1},y:{show:!1,highlight:!0,start:0,end:0,size:1,color:"#000",usecolormap:!1,width:1},z:{show:!1,highlight:!0,start:0,end:0,size:1,color:"#000",usecolormap:!1,width:1}}},layout={height:window.innerHeight,width:window.innerWidth,margin:{t:0,r:0,b:0,l:0,pad:0},autorange:!0,spikesides:!1,showlegend:!0,autosize:!0,scene:{aspectmode:"manual",aspectratio:{x:1,y:1,z:1},zaxis:{title:"",titlefont:{family:"Times New Roman",size:10},showticklabels:!0,tickfont:{family:"Times New Roman",size:15},tickmode:"auto",dtick:10,tickvals:"",ticktext:"",ticks:"outside",range:["",""],autorange:!0,spikesides:!1,showgrid:!0,zeroline:!1,showline:!0},yaxis:{title:"",titlefont:{family:"Times New Roman",size:10},showticklabels:!0,tickfont:{family:"Times New Roman",size:15},tickmode:"auto",dtick:10,tickvals:"",ticktext:"",ticks:"outside",range:["",""],autorange:!0,spikesides:!1,showgrid:!0,zeroline:!1,showline:!0},xaxis:{title:"",titlefont:{family:"Times New Roman",size:10},showticklabels:!0,tickfont:{family:"Times New Roman",size:15},tickmode:"auto",dtick:10,tickvals:"",ticktext:"",ticks:"outside",range:["",""],autorange:!0,spikesides:!1,showgrid:!0,zeroline:!1,showline:!0}}},mode={displaylogo:!1,modeBarButtonsToRemove:["toImage"],modeBarButtonsToAdd:[[{name:"Save the image",icon:Plotly.Icons.camera,click:function(){$("#download").show()}}]]};function fileLoader(){void 0!==(fname=dialog.showOpenDialog({properties:["openFile"],defaultPath:recentLocation}))&&(fname=fname[0],recentLocation=path.dirname(fname),fileReader(fname),$("#trace")[0].innerHTML="<option>1</option>",$("#trace")[0].selectedIndex=0,zCols.push(2),updateThisPlot(),updateJSON())}function transpose(e){return e[0].map((t,i)=>e.map(e=>e[i]))}function removeExtraTraces(){var e=figurecontainer.data.length-1;if(e){var t=[];for(let i=1;i<=e;i++)t.push(i);Plotly.deleteTraces(figurecontainer,t)}}function fileReader(e){removeExtraTraces();var t=fs.readFileSync(e,"utf8");t=t.trim().split(/\t\t\t\t\t|\n\n/),col=t[0].trim().split("\n")[0].trim().split(/[\s\t]+/).length,data=[...Array(col)].map(e=>Array());for(var i=0;i<t.length;i++){blocks=t[i].trim().split("\n");for(var a=0;a<blocks.length;a++)blocks[a]=blocks[a].trim().split(/[\s\t]+/);blocks=transpose(blocks);for(var o=0;o<col;o++)data[o].push(blocks[o])}for(i=0;i<col;++i){let e=[].concat(...data[i]);ranges.push([Math.min(...e),Math.max(...e)])}var n="";for(i=1;i<=col;i++)n+="<option>"+i+"</option>";var s=$("#colSel select");for(i=0;i<s.length;i++)s[i].innerHTML=n,s[i].selectedIndex=i;$("#file_name1").html(path.basename(e))}function addNewPlot(){var e=figurecontainer.data.length,t="";for(let i=1;i<=e+1;i++)t+="<option>"+i+"</option>";document.getElementById("trace").innerHTML=t,document.getElementById("trace").selectedIndex=e,Plotly.addTraces(figurecontainer,trace),updateThisPlot()}function updateThisPlot(){var e=$("#trace")[0].selectedIndex;a=$("#zcol")[0].selectedIndex,b=$("#ycol")[0].selectedIndex,c=$("#xcol")[0].selectedIndex,zCols[e]=a,Plotly.restyle(figurecontainer,{x:[data[c]],y:[data[b]],z:[data[a]]},e)}function traceUpdate(){var e=$("#trace")[0].selectedIndex;$("#zcol")[0].selectedIndex=zCols[e]}function deleteTrace(){var e=$("#trace")[0].selectedIndex;zCols.splice(e,1),zCols.length&&(Plotly.deleteTraces(figurecontainer,e),$("#trace")[0].selectedIndex=0,$("#zcol")[0].selectedIndex=zCols[0])}function getRange(e,t){var i,a;return e=e.split(",").map(e=>parseFloat(e)),[i,a]=t,isNaN(e[0])&&(e[0]=i),isNaN(e[1])&&(e[1]=a),cmin=Math.max(e[0],i),cmax=Math.min(e[1],a),[e,[cmin,cmax]]}function setXRange(e){if(""!=e){var t=$("#xcol")[0].selectedIndex+1,i=ranges[t],[e,[a,o]]=getRange(e,i);console.log(e),Plotly.relayout(figurecontainer,{"scene.xaxis.range":e})}else Plotly.relayout(figurecontainer,{"scene.xaxis.autorange":!0})}function setYRange(e){if(""!=e){var t=$("#xcol")[0].selectedIndex+1,i=ranges[t],[e,[a,o]]=getRange(e,i);Plotly.relayout(figurecontainer,{"scene.yaxis.range":e})}else Plotly.relayout(figurecontainer,{"scene.yaxis.autorange":!0})}function setZRange(e){if(""!=e){var t=[],i=[];for(let e of zCols)t.push(ranges[e][0]),i.push(ranges[e][1]);var a=[Math.min(...t),Math.max(...i)];console.log(a);var[e,[o,n]]=getRange(e,a);Plotly.relayout(figurecontainer,{"scene.zaxis.range":e}),Plotly.restyle(figurecontainer,{cmin:o,cmax:n})}else Plotly.relayout(figurecontainer,{"scene.zaxis.autorange":!0})}function downloadImage(){var e=$("#dfileName").val(),t=$("#fileFormat").val().toLocaleLowerCase(),i=$("#imRes").val().split("x");Plotly.downloadImage(figurecontainer,{filename:e,format:t,width:i[1],height:i[0]}),$("#download").hide()}function triggerDownload(){$("#download").show()}Plotly.newPlot(figurecontainer,[trace],layout,mode),figurecontainer.on("plotly_relayout",updateJSON);var minWidth=window.innerWidth/2.5;$("#split-bar").mousedown(function(e){e.preventDefault(),$(document).mousemove(function(e){e.preventDefault();var t=e.pageX-$("#sidebar").offset().left;t>minWidth/5&&t<window.innerWidth/2.5&&($("#sidebar").css("width",t-2),$("#full").css("margin-left",t),minWidth=t)})}),$("#split-bar2").mousedown(function(e){e.preventDefault(),$(document).mousemove(function(e){e.preventDefault();var t=e.pageX-$("#sidebar2").offset().left;t>minWidth/5&&t<window.innerWidth/2.5&&($("#sidebar2").css("width",t-2),$("#full").css("margin-left",t),$("#jsoneditor").css("width",t-7),minWidth=t)})}),$(document).mouseup(function(e){$(document).unbind("mousemove")});minWidth=window.innerWidth/4;function openNav(){$("#split-bar2").css("width",5),$("#sidebar2").css("width",minWidth),$("#jsoneditor").css("width",minWidth-5),$(".floatdiv").css("margin-left",minWidth+15),$("#figurecontainer").css("margin-left",minWidth+15),$(".basediv").css("margin-left",minWidth+6)}function closeNav(){$("#split-bar2").css("width",0),$("#sidebar2").css("width",0),$(".floatdiv").css("margin-left",10),$(".basediv").css("margin-left",0),$("#jsoneditor").css("width",195),$(".ham").toggle()}$("#split-bar2").mousedown(function(e){e.preventDefault(),$(document).mousemove(function(e){e.preventDefault();var t=e.pageX-$("#sidebar2").offset().left;t>minWidth/5&&t<window.innerWidth/2.5&&($("#sidebar2").css("width",t-2),$(".floatdiv").css("margin-left",t+10),$(".basediv").css("margin-left",t),$("#jsoneditor").css("width",t-7),minWidth=t)})}),$(document).mouseup(function(e){$(document).unbind("mousemove")});var typeList=["Arial","Balto","Courier New","Droid Sans","Droid Serif","Droid Sans Mono","Gravitas One","Old Standard TT","Open Sans","Overpass","PT Sans Narrow","Raleway","Times New Roman"],colorPallete=["Greys","YlGnBu","Greens","YlOrRd","Bluered","RdBu","Reds","Blues","Picnic","Rainbow","Portland","Jet","Hot","Blackbody","Earth","Electric","Viridis","Cividis"],schema={properties:{Surfaces:{properties:{colorscale:{type:"array",items:{type:"string",enum:colorPallete}}}},Layout:{properties:{Zaxis:{properties:{title:{properties:{font:{properties:{family:{enum:typeList}}}}},tickfont:{properties:{family:{enum:typeList}}},tickmode:{enum:["auto","linear","data"]},ticks:{enum:["outside","inside",""]}}},Yaxis:{properties:{title:{properties:{font:{properties:{family:{enum:typeList}}}}},tickfont:{properties:{family:{enum:typeList}}},tickmode:{enum:["auto","linear","data"]},ticks:{enum:["outside","inside",""]}}},Xaxis:{properties:{title:{properties:{font:{properties:{family:{enum:typeList}}}}},tickfont:{properties:{family:{enum:typeList}}},tickmode:{enum:["auto","linear","data"]},ticks:{enum:["outside","inside",""]}}}}}}},options={onChangeJSON:function(e){var t=figurecontainer.layout;t.scene.aspectmode="manual",t.scene.aspectratio=e.Layout.aspectratio,t.scene.xaxis=e.Layout.Xaxis,t.scene.yaxis=e.Layout.Yaxis,t.scene.zaxis=e.Layout.Zaxis,t.scene.zaxis.tickvals=e.Layout.Zaxis.tickvals.split(","),t.scene.zaxis.ticktext=e.Layout.Zaxis.ticktext.split(","),t.scene.xaxis.tickvals=e.Layout.Xaxis.tickvals.split(","),t.scene.xaxis.ticktext=e.Layout.Xaxis.ticktext.split(","),t.scene.yaxis.tickvals=e.Layout.Yaxis.tickvals.split(","),t.scene.yaxis.ticktext=e.Layout.Yaxis.ticktext.split(","),console.log(t),Plotly.update(figurecontainer,e.Surfaces,t)},onColorPicker:function(e,t,i){new JSONEditor.VanillaPicker({parent:e,color:t,popup:"bottom",onChange:function(e){var t=1===e.rgba[3]?e.hex.substr(0,7):e.hex;i(t)}}).show()},mode:"form",schema:schema},jsoneditor=document.getElementById("jsoneditor"),editor=new JSONEditor(jsoneditor,options,{Surfaces:"",Layout:""});function updateJSON(){var e={hoverinfo:[],colorscale:[],opacity:[],name:[],hoverlabel:[],showscale:[],cmin:[],cmax:[],cauto:[],colorbar:[],contours:[],hidesurface:[]};for(let t of figurecontainer.data)for(let i of Object.keys(e))e[i].push(t[i]);var t={aspectratio:figurecontainer.layout.scene.aspectratio,Xaxis:figurecontainer.layout.scene.xaxis,Yaxis:figurecontainer.layout.scene.yaxis,Zaxis:figurecontainer.layout.scene.zaxis};try{t.Xaxis.ticktext=figurecontainer.layout.scene.xaxis.ticktext.join(","),t.Xaxis.tickvals=figurecontainer.layout.scene.xaxis.tickvals.join(",")}catch(e){}try{t.Yaxis.ticktext=figurecontainer.layout.scene.yaxis.ticktext.join(","),t.Yaxis.tickvals=figurecontainer.layout.scene.yaxis.tickvals.join(",")}catch(e){}try{t.Zaxis.ticktext=figurecontainer.layout.scene.zaxis.ticktext.join(","),t.Zaxis.tickvals=figurecontainer.layout.scene.zaxis.tickvals.join(",")}catch(e){}editor.update({Surfaces:e,Layout:t})}function saveConfig(){var e=dialog.showSaveDialog({title:"Save Configuration",filters:[{name:"JSON",extensions:["json"]}],defaultPath:recentLocation});if(void 0!==e){recentLocation=path.dirname(e);var t={aspectratio:figurecontainer.layout.scene.aspectratio,Xaxis:figurecontainer.layout.scene.xaxis,Yaxis:figurecontainer.layout.scene.yaxis,Zaxis:figurecontainer.layout.scene.zaxis};try{t.Xaxis.ticktext=figurecontainer.layout.scene.xaxis.ticktext.join(","),t.Xaxis.tickvals=figurecontainer.layout.scene.xaxis.tickvals.join(",")}catch(e){}try{t.Yaxis.ticktext=figurecontainer.layout.scene.yaxis.ticktext.join(","),t.Yaxis.tickvals=figurecontainer.layout.scene.yaxis.tickvals.join(",")}catch(e){}try{t.Zaxis.ticktext=figurecontainer.layout.scene.zaxis.ticktext.join(","),t.Zaxis.tickvals=figurecontainer.layout.scene.zaxis.tickvals.join(",")}catch(e){}var i={hoverinfo:[],colorscale:[],autocolorscale:[],opacity:[],name:[],hoverlabel:[],showscale:[],cmin:[],cmax:[],cauto:[],colorbar:[],contours:[]};for(let e of figurecontainer.data)for(let t of Object.keys(i))i[t].push(e[t]);var a=$("#ycol")[0].selectedIndex,o=$("#xcol")[0].selectedIndex,n=zCols,s=fname;fs.writeFileSync(e,JSON.stringify({file:s,x:a,y:o,z:n,surfaces:i,Layout:t},null,"\t"),"utf8")}}function loadConfig(){removeExtraTraces();const e=dialog.showOpenDialog({properties:["openFile"],filters:[{name:"JSON",extensions:["json"]}],defaultPath:recentLocation});if(void 0!==e){var t=JSON.parse(fs.readFileSync(e[0],"utf8"));fname=t.file,recentLocation=path.dirname(e[0]),fileReader(t.file),zCols=t.z;var i="";for(let e=1;e<=zCols.length;e++)i+="<option>"+e+"</option>";$("#trace")[0].innerHTML=i,$("#trace")[0].selectedIndex=0,$("#zcol")[0].selectedIndex=zCols[0],$("#ycol")[0].selectedIndex=t.y,$("#xcol")[0].selectedIndex=t.x;var a=[];if(zCols.length>1){for(let e=1;e<zCols.length;e++)a.push(trace);Plotly.addTraces(figurecontainer,a)}t.surfaces.x=[data[t.x]],t.surfaces.y=[data[t.y]],t.surfaces.z=[];for(let e of zCols)t.surfaces.z.push(data[e]);var o=figurecontainer.layout;o.scene.aspectmode="manual",o.scene.aspectratio=t.Layout.aspectratio,o.scene.xaxis=t.Layout.Xaxis,o.scene.yaxis=t.Layout.Yaxis,o.scene.zaxis=t.Layout.Zaxis,o.scene.zaxis.tickvals=t.Layout.Zaxis.tickvals.split(","),o.scene.zaxis.ticktext=t.Layout.Zaxis.ticktext.split(","),o.scene.xaxis.tickvals=t.Layout.Xaxis.tickvals.split(","),o.scene.xaxis.ticktext=t.Layout.Xaxis.ticktext.split(","),o.scene.yaxis.tickvals=t.Layout.Yaxis.tickvals.split(","),o.scene.yaxis.ticktext=t.Layout.Yaxis.ticktext.split(","),Plotly.update(figurecontainer,t.surfaces,o),updateJSON()}}$("#jsoneditor").height(window.innerHeight-jsoneditor.offsetTop),ipcRenderer.on("menuTrigger",function(e,t){"topbar"==t?$(".floatdiv").toggle():"open"==t?fileLoader():"lcon"==t?loadConfig():"scon"==t?saveConfig():"side"==t&&($("#sidebar2").width()?closeNav():openNav())});