const fs=require("fs"),path=require("path"),url=require("url");function isDev(){const isEnvSet="ELECTRON_IS_DEV"in process.env,getFromEnv=1===parseInt(process.env.ELECTRON_IS_DEV,10);return isEnvSet?getFromEnv:!app.isPackaged}function showStatus(msg){$("#status").html(msg),$("#status").delay("medium").fadeIn(),$("#status").delay(3e3).fadeOut()}function updateData(){if(col.x=xCol.selectedIndex,col.y=yCol.selectedIndex,col.z=zCol.selectedIndex,th_in=0,ddd?($slider.slider({max:data.length-1,value:0}),$ch.text(xName+"="+data[0][col.x][0])):(col.z=col.y,col.y=col.x,col.x=0),updatePlot(1),startDragBehavior(),updateOnServer(),!swapped)if(ddd)localStorage.setItem("cols3d",JSON.stringify(col));else{var tmp={x:col.y,y:col.z,z:0,s:0};localStorage.setItem("cols2d",JSON.stringify(tmp))}var tmpl=[];for(let i of data)tmpl.push(i[col.x][0].toString().length);$ch.width(Math.floor(Math.max(...tmpl)/2+2)*em2px)}function thisJobs(){if($("#particle").remove(),$("#full").show(),xCol=document.getElementById("xCol"),yCol=document.getElementById("yCol"),ddd){var fl;$(".3D").show(),null!==(fl=JSON.parse(localStorage.getItem("cols3d")))&&(col=fl);var mn=["pax","wire","surf"];for(let i of mn)menu.getMenuItemById(i).enabled=!0}else{var fl;serve=0,$(".3D").hide(),null!==(fl=JSON.parse(localStorage.getItem("cols2d")))&&(col=fl);var mn=["pax","wire","surf"];for(let i of mn)menu.getMenuItemById(i).enabled=!1}for(var op="",i=1;i<=data[0].length;i++)op+="<option>"+i+"</option>";for(var tmp=$("#xCol, #yCol, #zCol, #sCol"),i=0;i<tmp.length;i++)tmp[i].innerHTML=op;resizePlot(),xCol.selectedIndex=col.x,yCol.selectedIndex=col.y,zCol.selectedIndex=col.z,sCol.selectedIndex=col.s,updateData()}function fileLoader(){const fname=dialog.showOpenDialog({defaultPath:recentLocation,properties:["openFile"]});void 0!==fname&&fileReader(fname[0])}function fileReader(fname){swapped=0,refdat=0,xName="X";var dirname=path.dirname(fname),filename=path.basename(fname,path.extname(fname)),extn=path.extname(fname);save_name=path.join(dirname,filename+"_new"+extn),recentLocation=dirname,localStorage.setItem("recent",JSON.stringify(recentLocation)),data=fs.readFileSync(fname,"utf8"),data=parseData(data),ddd=1!=data.length,thisJobs(),showStatus("Data loaded ..."),document.title="Interactive Data Editor - "+replaceWithHome(fname),recentFiles=recentFiles.filter(x=>x!=fname),recentFiles.push(fname),recentFiles.length>10&&recentFiles.splice(0,1),recentMenu(),menu.getMenuItemById("pax").visible=!0,menu.getMenuItemById("pay").visible=!1,menu.getMenuItemById("compf").visible=!1,menu.getMenuItemById("swapen").visible=!0,menu.getMenuItemById("swapex").visible=!1,$("#sCol, #sColInp").hide(),swapper=!1,2==figurecontainer.data.length&&Plotly.deleteTraces(figurecontainer,1),Plotly.relayout(figurecontainer,{selectdirection:"any"});var mn=["save","saveas","spr","openc","pamh","swapen","edat","fill","filter"];ddd&&mn.push("pax","wire","surf");for(let i of mn)menu.getMenuItemById(i).enabled=!0;var[n1,n2]=["Y","X"];$ch.text(xName+"="+data[th_in][col.x][0]),$("#drag").html((_,html)=>html.replace(n1,n2))}function compfileLoader(){refdat=1;var fname=dialog.showOpenDialog({defaultPath:recentLocation,properties:["openFile"]});void 0!==fname&&(fname=fname[0],compdata=fs.readFileSync(fname,"utf8"),compdata=parseData(compdata),swapped&&(compdata=expRotate(compdata)),compFName=replaceWithHome(fname),showStatus(compFName+" loaded for comparison."),updatePlot(1),menu.getMenuItemById("compf").visible=!0)}function transpose(m){return m[0].map((_,i)=>m.map(x=>x[i]))}function parseData(strDps){var newdat=[],blocks=[];strDps=strDps.trim().split(/\t\t\t|\n\n/);for(let i of strDps){blocks=i.trim().split("\n");for(var j=0;j<blocks.length;j++)blocks[j]=blocks[j].trim().split(/[\s\t]+/),blocks[j]=blocks[j].map(x=>parseFloat(x));newdat.push(transpose(blocks))}return newdat}function expRotate(tmpData){var issame=!0,b=(tmpData=tmpData.map(x=>transpose(x)))[0].length;for(let a of tmpData)if(a.length!=b){issame=!1;break}if(issame)return tmpData=(tmpData=transpose(tmpData)).map(x=>transpose(x));tmpData=[].concat(...tmpData).filter(x=>void 0!==x);var tmp=new Set;for(let a of tmpData)tmp.add(a[col.x]);tmp=[...tmp].sort((a,b)=>a-b);var newdat=[];for(let x of tmp){var tmpdat=[];for(let line of tmpData)x==line[col.x]&&tmpdat.push(line);tmpdat=tmpdat.sort((m,n)=>m[col.y]-n[col.y]),newdat.push(transpose(tmpdat))}return newdat}function rotateData(){data.length&&(data=expRotate(data),compdata.length&&(compdata=expRotate(compdata)))}function saveAs(){if(data.length){var tmp_name=dialog.showSaveDialog({title:"Save As:",defaultPath:save_name});void 0!==tmp_name&&(save_name=tmp_name,saveData())}else alert("Nothing to save!")}function saveData(){if(data.length){var tmpData=data.map(x=>transpose(x));swapped&&(tmpData=transpose(tmpData));var txt="";for(let i of tmpData){for(let j of i)txt+=j.map(n=>parseFloat(n).toFixed(8)).join("\t")+"\n";txt+="\n"}fs.writeFileSync(save_name,txt),showStatus("Data Saved as "+replaceWithHome(save_name)),saved=!0}else alert("Nothing to save!")}function editor(){editorWindow=new BrowserWindow({minWidth:1200,show:!1,webPreferences:{nodeIntegration:!0}}),editorWindow.maximize(),editorWindow.loadURL(url.format({pathname:path.join(__dirname,"handtable.html"),protocol:"file:",slashes:!0})),editorWindow.setMenuBarVisibility(!1),editorWindow.show(),isDev()&&editorWindow.webContents.openDevTools(),editorWindow.webContents.once("dom-ready",function(){editorWindow.webContents.send("slider",[xName,col.x,data])})}function openViewer(x){serve=1;var target="3D_Viewer_Lines.html";x&&(target="3D_Viewer_Surface.html"),viewerWindow=new BrowserWindow({show:!1,minWidth:1200,webPreferences:{nodeIntegration:!0}}),viewerWindow.maximize(),setTimeout(function(){viewerWindow.loadURL(url.format({pathname:path.join(__dirname,target),protocol:"file:",slashes:!0}))},50),viewerWindow.on("closed",function(){delete viewer[target]}),viewerWindow.show(),viewerWindow.setMenuBarVisibility(!1),viewer[target]=viewerWindow,isDev()&&viewerWindow.webContents.openDevTools(),viewerWindow.webContents.once("dom-ready",function(){updateOnServer()})}function incRefData(){var mark;menu.getMenuItemById("compf").checked?(refdat=1,updatePlot(1),showStatus(compFName+" shown for comparison.")):(refdat=0,Plotly.deleteTraces(figurecontainer,1))}function isswap(){swapped=!swapped;var[n1,n2]=["Y","X"];swapped&&([n1,n2]=[n2,n1]),xName=n2,[xCol,yCol]=[yCol,xCol],[col.x,col.y]=[col.y,col.x],rotateData(),updateData(),th_in=0,$slider.slider("value",0),$ch.text(xName+"="+data[th_in][col.x][0]),$("#drag").html((_,html)=>html.replace(n1,n2))}function sliderChanged(){$("#custom-handle").blur(),$slider.slider("value",th_in),$ch.text(xName+"="+data[th_in][col.x][0]),updatePlot(1),startDragBehavior()}function colsChanged(value){col.s=value,updatePlot()}function colChanged(value){$("select").blur(),col.z=value,updatePlot(1),updateOnServer(),startDragBehavior(),swapped||localStorage.setItem("cols3d",JSON.stringify(col))}function resizePlot(){var height=window.innerHeight-document.getElementById("header").offsetTop-document.getElementById("figurecontainer").offsetTop;$("#figurecontainer").height(height-2),Plotly.relayout(figurecontainer,{autosize:!0})}function sSwapper(){[col.s,col.z]=[col.z,col.s],sCol.selectedIndex=col.s,zCol.selectedIndex=col.z,updatePlot(),updateOnServer()}function initSwapper(){$("#sCol, #sColInp").show(),refdat=0,swapper=!0,2==figurecontainer.data.length&&Plotly.deleteTraces(figurecontainer,1),Plotly.addTraces(figurecontainer,iniPointsC),col.s=sCol.selectedIndex,Plotly.relayout(figurecontainer,{selectdirection:"h"}),updatePlot(),menu.getMenuItemById("swapen").visible=!1,menu.getMenuItemById("swapex").visible=!0}function delSwapper(){$("#sCol, #sColInp").hide(),swapper=!1,2==figurecontainer.data.length&&Plotly.deleteTraces(figurecontainer,1),Plotly.relayout(figurecontainer,{selectdirection:"any"}),updatePlot(),menu.getMenuItemById("swapen").visible=!0,menu.getMenuItemById("swapex").visible=!1}function selectEvent(event){if(index=[],del_dat=[],null==event)Plotly.restyle(figurecontainer,{selectedpoints:[null]});else{for(let pt of event.points)ind=dpsx.findIndex(n=>n==pt.x),dpsy[ind]==pt.y&&index.push(ind);index=[...new Set(index)]}}function updateFigure(){var y=[],x=[];if(lockXc){for(let i of points)y.push(i.handle.y);Plotly.restyle(figurecontainer,{y:[y]},0),dpsy=data[th_in][col.z]=y}else{for(let i of points)x.push(i.handle.x),y.push(i.handle.y);Plotly.restyle(figurecontainer,{x:[x],y:[y]},0),dpsy=data[th_in][col.z]=y,dpsx=data[th_in][col.y]=x}}function clamp(x,lower,upper){return Math.max(lower,Math.min(x,upper))}var oldX,oldCord,indd;function startDragBehavior(){var d3=Plotly.d3,drag=d3.behavior.drag();drag.origin(function(){saveOldData();var transform=d3.select(this).attr("transform"),translate=transform.substring(10,transform.length-1).split(/,| /);return index.length&&(oldX=dpsx,oldCord=dpsy,indd=oldX.indexOf(this.handle.x)),{x:translate[0],y:translate[1]}}),drag.on("drag",function(){var xmouse=d3.event.x,ymouse=d3.event.y;d3.select(this).attr("transform","translate("+[xmouse,ymouse]+")");var handle=this.handle,yaxis=figurecontainer._fullLayout.yaxis;if(handle.y=clamp(yaxis.p2l(ymouse),yaxis.range[0],yaxis.range[1]),index.length){var moved=handle.y-oldCord[indd];for(let ind of index)points[ind].handle.y=moved+oldCord[ind]}if(!lockXc){var xaxis=figurecontainer._fullLayout.xaxis;if(handle.x=clamp(xaxis.p2l(xmouse),xaxis.range[0],xaxis.range[1]),index.length){var moved=handle.x-oldX[indd];for(let ind of index)points[ind].handle.x=moved+oldX[ind]}}updateFigure()}),drag.on("dragend",function(){updateFigure(),updateOnServer(),d3.select(".scatterlayer .trace:first-of-type .points path:first-of-type").call(drag)}),d3.selectAll(".scatterlayer .trace:first-of-type .points path").call(drag)}function keyBoardDrag(inp){if(index.length){ma&&(saveOldData(),ma=0);var yaxis=figurecontainer._fullLayout.yaxis,add=yaxis.p2l(1)-yaxis.p2l(0);inp&&(add=-add);for(let ind of index)points[ind].handle.y+=add;updateFigure()}}function saveOldData(){data.length&&(redoStack=[],olddata=JSON.stringify([th_in,col,data[th_in]]),5==undoStack.length&&undoStack.splice(0,1),undoStack.push(olddata),saved=!1)}function reDo(){redoStack.length&&(olddata=redoStack.pop(),undoStack.push(JSON.stringify([th_in,col,data[th_in]])),doIt())}function unDo(){ma||(ma=1),undoStack.length&&(olddata=undoStack.pop(),redoStack.push(JSON.stringify([th_in,col,data[th_in]])),doIt())}function doIt(){var arr,tmp=th_in;[th_in,col,arr]=JSON.parse(olddata),zCol.selectedIndex=col.z,data[th_in]=arr,updatePlot(1),startDragBehavior(),updateOnServer(),saved=!1}function updateOnServer(){if(serve){var x_list=[],y_list=[],z_list=[];for(let i of data)x_list.push(i[col.x]),y_list.push(i[col.y]),z_list.push(i[col.z]);var s_data=[x_list,y_list,z_list];for(let w in viewer)viewer[w].webContents.send("sdata",s_data)}}function updatePlot(both=0){dpsy=data[th_in][col.z],dpsx=data[th_in][col.y],swapper?(dpsy2=data[th_in][col.s],Plotly.restyle(figurecontainer,{x:[dpsx,dpsx],y:[dpsy,dpsy2]})):both&&refdat&&compdata.length?(1==figurecontainer.data.length&&Plotly.addTraces(figurecontainer,iniPointsC),Plotly.restyle(figurecontainer,{x:[dpsx,compdata[th_in][col.y]],y:[dpsy,compdata[th_in][col.z]]})):Plotly.restyle(figurecontainer,{x:[dpsx],y:[dpsy]},0);for(var i=0;i<dpsx.length;i++)points[i].handle={x:dpsx[i],y:dpsy[i]}}