<!DOCTYPE html>
<html>

    <head>
        <title>Interactive Data Editor</title>
        <link rel="stylesheet" href='../lib/spreadsheet.min.css'>
        <link rel="stylesheet" href="../lib/jquery-ui.min.css">
        <script>
            if (typeof module === 'object') { window.module = module; module = undefined; }
        </script>
        <script src="../lib/jquery.min.js"></script>
        <script src="../lib/jquery-ui.min.js"></script>
        <script src="../lib/spreadsheet.min.js"></script>
    </head>

<body>

    <div id="container">
        <label id="fullS" style='margin-top: 10px;'>Spreadsheet is loading, please wait...</label>
        <input type="submit" value="Update Data" onclick="updateData();" style="float: right" id="btn">
        <div id="slider" style="background: #eaeaea; display: none">
            <div id="custom-handle" class="ui-slider-handle" style="background: #4CAF50; color:#ffffff"></div>
        </div>
    </div>
    <div id="table"></div>
    <script>
        const { remote, ipcRenderer } = require('electron');
        const { dialog, BrowserWindow, Menu } = remote;
        var full = document.getElementById("fullS");
        var xcol = [], data = [], hot, columns = [], xName, mytable;
        var btn = document.getElementById("btn");
        btn.style.visibility = "hidden";
        var event, th_in = 0, $ch = $("#custom-handle"), $slider = $("#slider");

        ipcRenderer.on("slider", function (e, d) {
            // e.sender.send("test", "2u3i")
            var [t, _, _] = d;
            xName = t;
            xcol = d[1];
            data = d[2].map(x => transpose(x));
            if (data.length != 1) { // if data is 3d show the slider
                full.innerHTML = `Drag the slider to change "${xName}" value:`
                $slider.show()
                $(function () {
                    $slider.slider({
                        min: 0, max: data.length - 1, step: 1,
                        slide: function (event, ui) {
                            th_in = ui.value;
                            sliderChanged();
                        }
                    });
                });

            } else {
                full.style.display = "none";
            }
            var height = window.innerHeight -
                document.getElementById("container").offsetTop - 2 -
                document.getElementById("table").offsetTop;

            $ch.text(xName + '=' + data[0][0][xcol]);

            var wit = (window.innerWidth-450)/data[0][0].length
            mytable = jexcel(document.getElementById('table'), {
                        // copyCompatibility:true,
                        data:data[0],
                        tableOverflow:true,
                        defaultColWidth:wit>120?120:wit,
                        lazyLoading:true,
                        columnDrag :true,
                        rowDrag:true,
                        csvFileName : 'data.csv',
                        tableWidth :window.innerWidth-100,
                        updateTable:function(_, cell, _, _, _, label, _) {cell.style.color = parseFloat(label)!=label ? 'red' : '#000000'},
                        onload:_=>setTimeout(_=>{let tt=$('.jexcel_content'); tt.height(window.innerHeight-tt.offset().top-10)},1), 
                        onchange:_=>btn.style.visibility = "visible"})
            })


        function sliderChanged() {
            $slider.slider("value", th_in)
            $ch.text(xName + '=' + data[th_in][0][xcol]);
            mytable.setData(data[th_in])
        };

        function transpose(m) {
            return m[0].map((_, i) => m.map(x => x[i]));
        };



        function updateData() { //parse the formulas during the return 
            btn.style.visibility = "hidden";
            var dat = data.map(blocks=> blocks.map(line=>line.map(elem=>{
                if (('' + elem).substr(0,1) == '=')  return mytable.executeFormula(elem); return elem
            })))
            ipcRenderer.send("back", dat); 
        }


        function hotKeys(e) {
            if (document.activeElement.type == "text") {
                return;
            };
            switch (e.key) {
                case ",":
                    if (th_in == 0) break;
                    th_in = th_in - 1
                    sliderChanged();
                    break;
                case ".":
                    if (th_in == data.length - 1) break;
                    th_in = th_in + 1
                    sliderChanged();
                    break;
            };
        };
        $(window).keydown(hotKeys);

    </script>


</body>

</html>