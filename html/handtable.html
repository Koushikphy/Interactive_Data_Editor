<!DOCTYPE html>
<html>

<head>
    <title>Interactive Data Editor</title>
    <link href="../lib/style.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../lib/jquery-ui.min.css">
    <script>
    if (typeof module === 'object') { window.module = module; module = undefined; }
    </script>
    <script src="../lib/jquery.min.js"></script>
    <script src="../lib/jquery-ui.min.js"></script>
    <script src="../handsontable/for/handsontable.full.js"></script>
    <script src="../handsontable/for/handsontable.formula.js"></script>
    <link href="../handsontable/dist/handsontable.full.min.css" rel="stylesheet" media="screen">
    <script src="../handsontable/for/numeric.js"></script>
    <script src="../handsontable/for/parser.js"></script>
    <script src="../handsontable/for/ruleJS.js"></script>
    <script src="../handsontable/for/underscore.string.js"></script>
    <script src="../handsontable/for/formula.js"></script>
</head>

<body>


    <div id="container">
        <label id="fullS" style='margin-top: 10px;'>Spreadsheet is loading, please wait...</label>
        <input type="submit" value="Update Data" onclick="updateData();" style="float: right" id="btn">
        <div id="slider" style="background: #eaeaea; display: none">
            <div id="custom-handle" class="ui-slider-handle" style="background: #4CAF50; color:#ffffff"></div>
        </div>
    </div>
    <div id="table"></div>
    <script>
        const { remote, ipcRenderer } = require('electron');
        const { dialog, BrowserWindow, Menu } = remote;
        var full = document.getElementById("fullS");
        var xcol = [], data = [], hot, columns = [], xName;
        var btn = document.getElementById("btn");
        btn.style.visibility = "hidden";
        var event, th_in = 0,
            $ch = $("#custom-handle"),
            $slider = $("#slider");

        ipcRenderer.on("slider", function (e, d) {
            e.sender.send("test", "2u3i")
            var [t, _, _] = d;
            xName = t;
            xcol = d[1];
            data = d[2].map(x => transpose(x));
            if (data.length != 1) {
                full.innerHTML = `Drag the slider to change "${xName}" value:`
                $slider.show()
                $(function () {
                    $slider.slider({
                        min: 0, max: data.length - 1, step: 1,
                        slide: function (event, ui) {
                            th_in = ui.value;
                            sliderChanged();
                        }
                    });
                });

            } else {
                full.style.display = "none";
            }
            var height = window.innerHeight -
                document.getElementById("container").offsetTop - 2 -
                document.getElementById("table").offsetTop;


            // for (var i = data[0][0].length; i > 0; i--) {
            //     columns.push({ type: "numeric" })
            // };
            $ch.text(xName + '=' + data[0][0][xcol]);
            hot = new Handsontable(document.getElementById("table"), {
                data: data[0],
                height: height,
                // columns: columns,
                rowHeaders: true,
                colHeaders: true,
                contextMenu: true,
                columnSorting: true,
                manualColumnResize: true,
                manualRowResize: true,
                formulas:true,
                afterChange: function change(e, d) { if (d != "loadData") btn.style.visibility = "visible" }
            });

        })


        function sliderChanged() {
            $ch.text(xName + '=' + data[th_in][0][xcol]);
            hot.updateSettings({ data: data[th_in] })
        };

        function transpose(m) {
            return m[0].map((_, i) => m.map(x => x[i]));
        };




        var allAlpha = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'
        function parseValue(str, block){
            let old = str
            var loc = str.match(/[A-Z]+[0-9]+/g)   // got all the location reference
            for(let item of loc){

                let row = parseInt(item.match(/[0-9]+/g)[0]-1)
                let col = allAlpha.search( item.match(/[A-Z]+/g)[0])
                str = str.replace( item , block[row][col]  )
            }
            return str
        }
        const rule = new ruleJS()
        rule.init()



        function updateData() {
            btn.style.visibility = "hidden";

            let tmpDat = data.map(function(block){  // clean data
            let tmpBlock=[]
            for(let row of block){
                row = row.filter(el=>el!=null)
                tmpBlock.push(row)
            }
            return tmpBlock.filter(el=>el.length)
            })

            tmpDat = tmpDat.map(function(block){
                var nRows = block.length;
                var nCols = block[0].length
                for(let i=0;i<nRows;i++){
                    for(let j=0;j<nCols;j++){
                    value = block[i][j]
                    val = parseFloat(value);
                    if (!isNaN(val)) {
                        block[i][j]= val
                        continue
                    }
                    //formula found
                    formula = parseValue(value.substr(1), block) //remove '=' sign
                    block[i][j] = rule.parse(
                        formula,{
                        row: i,
                        col: j,
                        id: 'A1'
                        }
                    ).result
                    }
                }
                return block
                })
                    // console.log(tmpDat)
            ipcRenderer.send("back", tmpDat);
        }


        function hotKeys(e) {
            if (document.activeElement.type == "text") {
                return;
            };
            switch (e.key) {
                case ",":
                    if (th_in == 0) break;
                    th_in = th_in - 1
                    $slider.slider("value", th_in)
                    sliderChanged();
                    break;
                case ".":
                    if (th_in == data.length - 1) break;
                    th_in = th_in + 1
                    $slider.slider("value", th_in)
                    sliderChanged();
                    break;
            };
        };
        $(window).keydown(hotKeys);

    </script>


</body>

</html>