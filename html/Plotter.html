<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>3D Plotter</title>
    <link href="../lib/style.min.css" rel="stylesheet" />
    <script>if (typeof module === 'object') { window.module = module; module = undefined; }</script>
    <script src="../lib/jquery.min.js"></script>
</head>

<body>
    <div class="basediv" id="figurecontainer"></div>
    <div class="floatdiv">
        <input type="submit" value="Choose File" onclick="fileLoader();">
        <label id="file_name1" style="display: inline-block;width: 10pc"> No File Choosen.</label>
        Select Plot Style :
        <select autocomplete="off" disabled="" id="ssel" onchange="updatePlot();" style="width: 71px">
            <option selected="">Line</option>
            <option>Surface</option>
        </select>
        <p></p>
        <div class="borders" id="colSel" onchange="updatePlot();">
            Data Column ⇒
            X :<select id="xcol"></select>
            Y :<select id="ycol"></select>
            Z :<select id="zcol"></select>    
        </div>
        <div class="borders">
            Axes Ranges ⇒
            X : <input onchange="setXRange(this.value, ranges[cols[0]])" type="text" />
            Y : <input onchange="setYRange(this.value, ranges[cols[1]])" type="text" />
            Z : <input onchange="setZRange(this.value, ranges[cols[2]])" type="text" />
        </div><br />
    </div>
    <script src="../lib/viewer.min.js"></script>
    <script>

        // const Plotly = require('plotly.js-gl3d-dist');
        const fs = require("fs");
        const { remote } = require('electron');
        const path = require('path');
        const { dialog } = remote;
        Plotly.newPlot(figurecontainer, sIniData, layout);


        function updatePlot() {
            var cur = figurecontainer.data[0].type;
            var val = $("#ssel")[0].selectedIndex;
            cols = [];
            for (let a of $("#colSel select")) {
                cols.push(a.selectedIndex)
            };
            if (val == 0) {
                if (cur == "surface") {
                    Plotly.newPlot(figurecontainer, lIniData, layout);
                };
                Plotly.restyle(figurecontainer, { 'x': ldata[cols[0]], 'y': ldata[cols[1]], 'z': ldata[cols[2]] });
            } else {
                if (cur == "scatter3d") {
                    Plotly.newPlot(figurecontainer, sIniData, layout);
                };
                Plotly.restyle(figurecontainer, { "x": [data[cols[0]]], "y": [data[cols[1]]], "z": [data[cols[2]]] });
            };
        };



        function selUpdate() {
            var op = "";
            for (var i = 1; i <= col; i++) {
                op += '<option>' + i + '</option>';
            };
            var tmp = $("#colSel select");
            for (var i = 0; i < tmp.length; i++) {
                tmp[i].innerHTML = op;
                tmp[i].selectedIndex = i;
            };
        };


        function fileLoader() {
            const fname = dialog.showOpenDialog({ properties: ['openFile'] })[0];
            var dirname = path.dirname(fname);
            var filename = path.basename(fname)
            var strDps = fs.readFileSync(fname, "utf8");
            strDps = strDps.trim().split(/\t\t\t\t\t|\n\n/);
            col = strDps[0].trim().split("\n")[0].trim().split(/[\s\t]+/).length;
            data = [...Array(col)].map(_ => Array());
            for (var i = 0; i < strDps.length; i++) {
                blocks = strDps[i].trim().split("\n");
                for (var j = 0; j < blocks.length; j++) {
                    blocks[j] = blocks[j].trim().split(/[\s\t]+/);
                };
                blocks = transpose(blocks);
                for (var k = 0; k < col; k++) {
                    data[k].push(blocks[k]);
                };
            };
            selUpdate();
            ldata = [...Array(col)].map(_ => Array());
            for (var i = 0; i < col; ++i) {
                ldata[i] = data[i].concat(transpose(data[i]));
                let flat_dat = [].concat(...data[i]);
                ranges.push([Math.min(...flat_dat), Math.max(...flat_dat)]);
            };
            lIniData = initData(ldata[0].length);
            updatePlot();
            $("#ssel")[0].disabled = false;
            $("#file_name1").html(filename);
        }

    </script>
</body>

</html>