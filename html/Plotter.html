<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>3D Plotter</title>
    <link href="../lib/style.min.css" rel="stylesheet" >
    <link rel="stylesheet" href="../lib/jsoneditor.min.css">
    <script>if (typeof module === 'object') { window.module = module; module = undefined; }</script>
    <script src="../lib/jquery.min.js"></script>
</head>

<body>
    <div class="basediv" id="figurecontainer"></div>
    <div class="floatdiv">


        <div class="borders">
            <input type="submit" value="Choose File" onclick="fileLoader();">
            <label id="file_name1" style="display: inline-block;width: 10pc"> No File Choosen.</label>
            Trace Index :<select id="trace"></select>
            <button id= "addTrace" alt="ihdi2h">C</button>
            <button id= "removeTrace" alt = "fihwifeh">X</button>
        </div>
        <div class="borders" id="colSel" onchange="updatePlot();">
            Data Column ⇒
            X :<select id="xcol"></select>
            Y :<select id="ycol"></select>
            Z :<select id="zcol"></select>    
        </div>
        <div class="borders">
            Axes Ranges ⇒
            X : <input onchange="setXRange(this.value, ranges[cols[0]])" type="text" alt="hwfh"/>
            Y : <input onchange="setYRange(this.value, ranges[cols[1]])" type="text" />
            Z : <input onchange="setZRange(this.value, ranges[cols[2]])" type="text" />
        </div><br />
    </div>

    <div id="sidebar">
        <div id="split-bar"></div>
        <div class="closebtn" onclick="closeNav()">&#9746;</div>
        <div class="sideheader"> Files Dashboard </div>
        <div id="files"></div>
    </div>

    <div id="sidebar2">
        <div id="split-bar2"></div>
        <div class="closebtn" onclick="closeNav2()">&#9746;</div>
        <div class="sideheader"> Plot Settings </div>
        <div id="jsoneditor"></div>
    </div>

    <div id="download">
        Download the image
        File Name: <input type="text" id= "dfileName"><br>
        File Type:<select id="fileFormat">
                <option>JPEG</option>
                <option>PNG</option>
                <option>SVG</option>
                <option>WEBP</option>
            </select><br>
        Image Resolution: <input type="text" id="imRes"><br>
        <input type="button" value="OK" onclick="downloadImage();">
        <input type="button" value="Cancel" onclick="$('#download').hide();">
    </div>




    <script src="../lib/jsoneditor.min.js"></script>
    <script src="../lib/viewer.min.js"></script>
    <script>
        function updateJSON() {
    var Title = []
    var Markers = []
    var Line = []
    for (let trace of figurecontainer.data) {
        Title.push(trace.name)
        Markers.push(trace.marker)
        Line.push(trace.line)
    }
    lines = {
        Title,
        Markers,
        Line
    }
    layout = figurecontainer.layout
    editor.update({
        lines,
        layout
    })
}
        // const Plotly = require('plotly.js-gl3d-dist');
        const fs = require("fs");
        const { remote } = require('electron');
        const path = require('path');
        const { dialog } = remote;
        Plotly.newPlot(figurecontainer, sIniData, layout);


        function updatePlot() {
            var cur = figurecontainer.data[0].type;
            var val = $("#ssel")[0].selectedIndex;
            cols = [];
            for (let a of $("#colSel select")) {
                cols.push(a.selectedIndex)
            };
            if (val == 0) {
                if (cur == "surface") {
                    Plotly.newPlot(figurecontainer, lIniData, layout);
                };
                Plotly.restyle(figurecontainer, { 'x': ldata[cols[0]], 'y': ldata[cols[1]], 'z': ldata[cols[2]] });
            } else {
                if (cur == "scatter3d") {
                    Plotly.newPlot(figurecontainer, sIniData, layout);
                };
                Plotly.restyle(figurecontainer, { "x": [data[cols[0]]], "y": [data[cols[1]]], "z": [data[cols[2]]] });
            };
figurecontainer.on("plotly_relayout", updateJSON);
        };





        function selUpdate() {
            var op = "";
            for (var i = 1; i <= col; i++) {
                op += '<option>' + i + '</option>';
            };
            var tmp = $("#colSel select");
            for (var i = 0; i < tmp.length; i++) {
                tmp[i].innerHTML = op;
                tmp[i].selectedIndex = i;
            };
        };


        function fileLoader() {
            const fname = dialog.showOpenDialog({ properties: ['openFile'] })[0];
            // fname = '/home/koushik/F+H2/Jacobi/C2V/EnrScalled_new.dat'
            var dirname = path.dirname(fname);
            var filename = path.basename(fname)
            var strDps = fs.readFileSync(fname, "utf8");
            strDps = strDps.trim().split(/\t\t\t\t\t|\n\n/);
            col = strDps[0].trim().split("\n")[0].trim().split(/[\s\t]+/).length;
            data = [...Array(col)].map(_ => Array());
            for (var i = 0; i < strDps.length; i++) {
                blocks = strDps[i].trim().split("\n");
                for (var j = 0; j < blocks.length; j++) {
                    blocks[j] = blocks[j].trim().split(/[\s\t]+/);
                };
                blocks = transpose(blocks);
                for (var k = 0; k < col; k++) {
                    data[k].push(blocks[k]);
                };
            };
            selUpdate();
            ldata = [...Array(col)].map(_ => Array());
            for (var i = 0; i < col; ++i) {
                ldata[i] = data[i].concat(transpose(data[i]));
                let flat_dat = [].concat(...data[i]);
                ranges.push([Math.min(...flat_dat), Math.max(...flat_dat)]);
            };
            lIniData = initData(ldata[0].length);
            updatePlot();
            $("#ssel")[0].disabled = false;
            $("#file_name1").html(filename);

Plotly.addTraces(figurecontainer,[{
    type: 'surface',
    hoverinfo: "x+y+z",
    colorscale: "Viridis",
    showscale:false,
    hoverlabel: {
        bgcolor: "#2ca02c"
    },
    z: [
        [1]
    ],
    x: [
        [1]
    ],
    y: [
        [1]
    ]
}])

Plotly.restyle(figurecontainer, { 'x': [data[0]], 'y': [data[1]], 'z': [data[6]]},1);
        }


        var minWidth = window.innerWidth / 4.5
        function openNav2() {
    $('#split-bar2').css("width", 5);
    $('#sidebar2').css("width", minWidth);
    $('#jsoneditor').css("width", minWidth - 5);
    $('.floatdiv').css("margin-left", minWidth + 15);
    $('.basediv').css("margin-left", minWidth + 6);
    $('.ham').toggle()
    // resizePlot()
}


function closeNav2() {
    $('#split-bar2').css("width", 0);
    $('#sidebar2').css("width", 0);
    $('.floatdiv').css("margin-left", 10);
    $('.basediv').css("margin-left", 0);
    $('#jsoneditor').css("width", 195);
    $('.ham').toggle()
    // resizePlot()
}



$('#split-bar2').mousedown(function (e) {
    e.preventDefault();
    $(document).mousemove(function (e) {
        e.preventDefault();
        var x = e.pageX - $('#sidebar2').offset().left;
        if (x > minWidth / 5.0 && x < window.innerWidth / 2.5) {
            $('#sidebar2').css("width", x - 2);
            // $('#full').css("margin-left", x);
            $('.floatdiv').css("margin-left", x+10);
            $('.basediv').css("margin-left", x);
            $('#jsoneditor').css("width", x - 7);
            minWidth = x;
            // resizePlot()
        }
    })
});

$(document).mouseup(function (e) {
    $(document).unbind('mousemove');
});


var jsoneditor = document.getElementById('jsoneditor')
var editor = new JSONEditor(
    jsoneditor,
    options, {
        "lines": '',
        "layout": ''
    });
$('#jsoneditor').height(window.innerHeight - jsoneditor.offsetTop)




var typeList = ["Arial", "Balto", "Courier New", "Droid Sans",, "Droid Serif", "Droid Sans Mono", "Gravitas One", "Old Standard TT", "Open Sans", "Overpass", "PT Sans Narrow", "Raleway", "Times New Roman"]
var symList =["circle","circle-open","circle-dot","circle-open-dot","square","square-open","square-dot","square-open-dot","diamond","diamond-open","diamond-dot","diamond-open-dot","cross","cross-open","cross-dot","cross-open-dot","x","x-open","x-dot","x-open-dot","triangle-up","triangle-up-open","triangle-up-dot","triangle-up-open-dot","triangle-down","triangle-down-open","triangle-down-dot","triangle-down-open-dot","triangle-left","triangle-left-open","triangle-left-dot","triangle-left-open-dot","triangle-right","triangle-right-open","triangle-right-dot","triangle-right-open-dot","triangle-ne","triangle-ne-open","triangle-ne-dot","triangle-ne-open-dot","triangle-se","triangle-se-open","triangle-se-dot","triangle-se-open-dot","triangle-sw","triangle-sw-open","triangle-sw-dot","triangle-sw-open-dot","triangle-nw","triangle-nw-open","triangle-nw-dot","triangle-nw-open-dot","pentagon","pentagon-open","pentagon-dot","pentagon-open-dot","hexagon","hexagon-open","hexagon-dot","hexagon-open-dot","hexagon2","hexagon2-open","hexagon2-dot","hexagon2-open-dot","octagon","octagon-open","octagon-dot","octagon-open-dot","star","star-open","star-dot","star-open-dot","hexagram","hexagram-open","hexagram-dot","hexagram-open-dot","star-triangle-up","star-triangle-up-open","star-triangle-up-dot","star-triangle-up-open-dot","star-triangle-down","star-triangle-down-open","star-triangle-down-dot","star-triangle-down-open-dot","star-square","star-square-open","star-square-dot","star-square-open-dot","star-diamond","star-diamond-open","star-diamond-dot","star-diamond-open-dot","diamond-tall","diamond-tall-open","diamond-tall-dot","diamond-tall-open-dot","diamond-wide","diamond-wide-open","diamond-wide-dot","diamond-wide-open-dot","hourglass","hourglass-open","bowtie","bowtie-open","circle-cross","circle-cross-open","circle-x","circle-x-open","square-cross","square-cross-open","square-x","square-x-open","diamond-cross","diamond-cross-open","diamond-x","diamond-x-open","cross-thin","cross-thin-open","x-thin","x-thin-open","asterisk","asterisk-open","hash","hash-open","hash-dot","hash-open-dot","y-up","y-up-open","y-down","y-down-open","y-left","y-left-open","y-right","y-right-open","line-ew","line-ew-open","line-ns","line-ns-open","line-ne","line-ne-open","line-nw","line-nw-open"]
var schema = {
    "properties": {
        'lines': {
            "properties": {
                "Line": {
                    "items": {
                        "properties": {
                            "width": {
                                "type": 'integer'
                            },
                            "dash": {
                                "type": 'integer'
                            },
                            "shape": {
                                "enum": ['linear', 'spline']
                            }
                        },
                    "required" : ['width', 'dash', 'shape']
                    }
                },
                "Markers": {
                    "items": {
                        "properties": {
                            "symbol": {
                                "enum": symList
                            },
                            "size": {
                                "type": "number"
                            },
                            "opacity": {
                                "type": "number"
                            }
                        }
                    }
                }
            }
        },
        "layout":{
            "properties":{
                "selectdirection":{
                    "enum":["v","h", "any"]
                },
                "dragmode":{
                    "enum":["select", "zoom"]
                },
                "hovermode":{
                    "enum":[ "false","x","y", "closest"]
                },
                "title":{
                    "properties":{
                        "font":{
                            "properties":{
                                "family":{
                                    "enum":typeList
                                },
                                "size":{
                                    "type":"number"
                                }
                            }
                        }
                        // "text":{
                        //     "type": "string"
                        // }
                    }
                },
                "xaxis":{
                        "properties":{
                            "type":{
                                "enum":['linear','log','date', 'category']
                            },
                            "title":{
                                "properties":{
                                    "font":{
                                        "properties":{
                                            "family":{
                                                "enum":typeList
                                            },
                                            "size":{
                                                "type":"number"
                                            }
                                        }
                                    }
                                    // "text":{
                                    //     "type": "string"
                                    // }
                                }
                            }
                        },
                        "required": ["type"]
                },
                "yaxis":{
                    "properties":{
                        "type":{
                            "enum":['linear','log','date', 'category']
                        },
                        "title":{
                            "properties":{
                                "font":{
                                    "properties":{
                                        "family":{
                                            "enum":typeList
                                        },
                                        "size":{
                                            "type":"number"
                                        }
                                    }
                                }
                                // "text":{
                                //     "type": "string"
                                // }
                            }
                        }
                    },
                    "required": ["type"]
            },
            }
        }
    }
}

var options = {
    onChangeJSON: function (json) {
        legendNames = json.lines.Title //.map(x => x.replace(/([ :0-9])$/g, ''))
        Plotly.restyle(figurecontainer, {
            name: json.lines.Title,
            marker: json.lines.Markers,
            line: json.lines.Line
        })
        Plotly.relayout(figurecontainer, json.layout)
        makeRows();
    },
    onColorPicker: function (parent, color, onChange) {
        new JSONEditor.VanillaPicker({
            parent: parent,
            color: color,
            popup: 'bottom',
            onChange: function (color) {
                var alpha = color.rgba[3]
                var hex = (alpha === 1) ?
                    color.hex.substr(0, 7) :
                    color.hex
                onChange(hex)
            },
            //   onDone: function (color) {
            //     console.log('onDone', color)
            //   },
            //   onClose: function (color) {
            //     console.log('onClose', color)
            //   }
        }).show();
    },
    mode: 'form',
    schema: schema
};

    </script>
</body>

</html>