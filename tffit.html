<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@0.11.7"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<input type="text" id ='formInput' value="a0*cos(x)+a1*x**2">
<button onclick="startTrain()">Start Training</button>
<button onclick="clearInterval(loop)">Stop Training</button>
<div id="fig"></div>




<script>
  tmp = Plotly.d3.range(10,721,1)
  const tfx = tf.tensor1d(tmp).mul(tf.scalar(Math.PI/180.0))
  const tfy = tfx.pow(tf.scalar(-1.5))
  const trainX = tfx.dataSync()
  const trainY = tfy.dataSync()

  var coeffList = []

  const learningRate = 0.1;
  const optimizer = tf.train.adadelta(learningRate);
// modify power
// not working for more than 3
// var c = a0.mul(x.cos()).add(a1.mul(x.sin()).add(a3.mul(pow(x,2)))

var dat = [{
    x: trainX,
    y: trainY,
    text : 'fvugherguierui',
    type: 'scatter',
    mode: 'markers',
    marker: {
        symbol: "circle-dot",
        color: '#b00',
        size: 3,
        opacity: 1
    }
  },
  {
    x: [[0]],
    y: [[0]],
    type: 'scatter',
    mode: 'lines',
    line: {
        width: 2,
        color: "#1e77b4",
        dash: 0,
        shape: 'linear'
    }
}]


  Plotly.newPlot(fig, dat, {title:'ebrguerbgeubg'})


  lossFunc = (prediction, labels)=> prediction.sub(labels).square().mean()


  function updatePlot(){
    
      lossVal = optimizer.minimize(()=> lossFunc(predict(tfx), tfy),true)  //train model
      console.log(lossVal.dataSync()[0], tf.memory().numTensors)
      yss = predict(tfx)
      Plotly.restyle(fig, {
          x: [trainX],
          y: [yss.dataSync()],
      },1)
      var values = ''
      for (let val of coeffList){
        values+= `${val.name} : ${val.val.dataSync()[0]},<br>`
      }
      values += `loss : ${lossVal.dataSync()[0]}`
      Plotly.relayout(fig , {title: values})
      yss.dispose()
      lossVal.dispose()
  }



  var predict, loop;
  function startTrain(){
    ff = getFuncFromStr()
    predict = (x)=> tf.tidy( function(){return ff(x)}) 
    loop = setInterval(updatePlot,100)
  }


// var tt = a0.mul(x.cos()).add(a1.mul(x.sin())).add(a3.mul(x.cos()))


  function getFuncFromStr(){
    var str = document.getElementById('formInput').value
    var ss = str.replace('**', 'pow')
        var ss = ss.trim().split('+').map(x=>x.trim().split('*'))
        var coeffPatter = /(a\d+)/
        var funcPattern=/([a-z]+\(x\))/

        var funcList = ['abs','acos','acosh','asin','asinh','atan','atanh','cos','cosh','exp','log','sin','sinh','sqrt','tan','tanh']
        
        var formStr = ss.map(term=>term.map(part=>{
            if(coeffPatter.test(part)){ //this is a coefficient
                eval(`${part}=tf.variable(tf.scalar(0))`)
                coeffList.push({name: part,val: eval(part)})
                return part
            } else if (funcPattern.test(part)){//this is a function
                func = part.replace('(x)','')
                if(funcList.includes(func)){
                    return `x.${func}()`
                }
            } else if(/xpow\(?[+-]?\d+\)?/.test(part)){//this is power term
                return `x.pow(tf.scalar(${part.replace('xpow','')}))`
            }else if (part=='x'){
              return part
            }else{
                throw "Can't parse the formula."
            }
        })).map(x=>{
          if(x.length==1){
            return x
          }else{
            return `${x[0]}.mul(${x[1]}).mul(` + x.slice(2).join(').mul(') + ')'
          }
        })
        console.log(formStr)
        if(formStr.length==1){
          formStr = formStr[0]
        }else{
          formStr = `${formStr[0]}.add(${formStr[1]}).add(` + formStr.slice(2).join(').add(') + ')'
        }
        console.log(formStr)
    return eval(`(function(x){return ${formStr}})`)
  }



</script>