<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@0.11.7"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<input type="text" id ='formInput' value="a0*cos(x)+a1*x**2">
<button onclick="startTrain()">Start Training</button>
<button onclick="clearInterval(loop)">Stop Training</button>
<div id="fig"></div>




<script>


var dpsx = [-1.03623000,-1.01053000,-0.98483700,-0.95914100,-0.72208400,-0.68331800,-0.64455200,-0.60578600,-0.56702000,-0.38293700,-0.33112700,-0.27931700,-0.22750600,-0.17569600,-0.04471300,0.02010600,0.08492500,0.14974400,0.21456200,0.29235700,0.37014000,0.44792300,0.52570600,0.60348900,0.62804000,0.71873400,0.80942800,0.90012200,0.96210700,0.99081500,1.06565000,1.16919000,1.27273000,1.37628000,1.41065000,1.52697000,1.64329000,1.75961000,1.88252000,2.01153000,2.14055000,2.51884000,3.0     	,4.0     	,5.0     	,6.0     	,7.0     	,8.0     	,9.0     	,10.0     	]
var dpsy = [2.41115000,2.17944000,1.97250000,1.78737000,0.76178300,0.67076600,0.59290400,0.52627500,0.46925000,0.29020600,0.25843000,0.23218700,0.21037700,0.19205800,0.15658600,0.14297700,0.13094500,0.12005900,0.11002700,0.09888300,0.08871100,0.07935700,0.07078600,0.06295000,0.06060100,0.05265800,0.04457000,0.04390400,0.03127600,0.03274400,0.02770300,0.02547200,0.02337700,0.01636200,0.01447100,0.01297800,0.01025300,0.00847500,0.00657900,0.00515400,0.00320700,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000,0.00000000]


  const tfx = tf.tensor1d(dpsx)//.mul(tf.scalar(Math.PI/180.0))
  const tfy = tf.tensor1d(dpsy)
  const trainX = tfx.dataSync()
  const trainY = tfy.dataSync()
  a1 = tf.variable(tf.scalar(1))
  a2 = tf.variable(tf.scalar(1))
  a3 = tf.variable(tf.scalar(1))
  a4 = tf.variable(tf.scalar(1))
  a5 = tf.variable(tf.scalar(1))
  a6 = tf.variable(tf.scalar(1))





  var coeffList = [a1,a2,a3,a4,a5,a6]

  const learningRate = 0.05;
  const optimizer = tf.train.adagrad(learningRate);


var dat = [{
    x: trainX,
    y: trainY,
    text : 'fvugherguierui',
    type: 'scatter',
    mode: 'markers',
    marker: {
        symbol: "circle-dot",
        color: '#b00',
        size: 3,
        opacity: 1
    }
  },
  {
    x: [[0]],
    y: [[0]],
    type: 'scatter',
    mode: 'lines',
    line: {
        width: 2,
        color: "#1e77b4",
        dash: 0,
        shape: 'linear'
    }
}]


  Plotly.newPlot(fig, dat, {title:'ebrguerbgeubg'})


  lossFunc = (prediction, labels)=> prediction.sub(labels).square().mean()
























  function predict(x) {
    return tf.tidy(function() {
      // return tf.exp(a2.add(a3.mul(x)).add(a4.mul(x.pow(tf.scalar(1)))).add(a4.mul(x.pow(tf.scalar(2))))).mul(a1).add(a6)
      return tf.scalar(1.0).add(a1.mul(x)).add(a2.mul(x.pow(tf.scalar(1)))).add(a3.mul(x.pow(tf.scalar(2)))).add(a4.mul(x.pow(tf.scalar(3)))).mul(tf.exp(x.mul(a5).mul(tf.scalar(-1)))).add(a6)
    });
  }



























  function updatePlot(){
    
      lossVal = optimizer.minimize(()=> lossFunc(predict(tfx), tfy),true)  //train model
      console.log(lossVal.dataSync()[0], tf.memory().numTensors)
      yss = predict(tfx)
      Plotly.restyle(fig, {
          x: [trainX],
          y: [yss.dataSync()],
      },1)
    //   var values = ''
    //   for (let val of coeffList){
    //     values+= `${val.name} : ${val.val.dataSync()[0]},<br>`
    //   }
    //   values += `loss : ${lossVal.dataSync()[0]}`
    //   Plotly.relayout(fig , {title: values})
      yss.dispose()
      lossVal.dispose()
  }



  var predict, loop;
  function startTrain(){
    // ff = getFuncFromStr()
    // predict = (x)=> tf.tidy( function(){return ff(x)}) 
    loop = setInterval(updatePlot,1)
  }


// var tt = a0.mul(x.cos()).add(a1.mul(x.sin())).add(a3.mul(x.cos()))


//   function getFuncFromStr(){
//     var str = document.getElementById('formInput').value
//     var ss = str.replace('**', 'pow')
//         var ss = ss.trim().split('+').map(x=>x.trim().split('*'))
//         var coeffPatter = /(a\d+)/
//         var funcPattern=/([a-z]+\(x\))/

//         var funcList = ['abs','acos','acosh','asin','asinh','atan','atanh','cos','cosh','exp','log','sin','sinh','sqrt','tan','tanh']
        
//         var formStr = ss.map(term=>term.map(part=>{
//             if(coeffPatter.test(part)){ //this is a coefficient
//                 eval(`${part}=tf.variable(tf.scalar(0))`)
//                 coeffList.push({name: part,val: eval(part)})
//                 return part
//             } else if (funcPattern.test(part)){//this is a function
//                 func = part.replace('(x)','')
//                 if(funcList.includes(func)){
//                     return `x.${func}()`
//                 }
//             } else if(/xpow\(?[+-]?\d+\)?/.test(part)){//this is power term
//                 return `x.pow(tf.scalar(${part.replace('xpow','')}))`
//             }else if (part=='x'){
//               return part
//             }else{
//                 throw "Can't parse the formula."
//             }
//         })).map(x=>{
//           if(x.length==1){
//             return x
//           }else{
//             return `${x[0]}.mul(${x[1]}).mul(` + x.slice(2).join(').mul(') + ')'
//           }
//         })
//         console.log(formStr)
//         if(formStr.length==1){
//           formStr = formStr[0]
//         }else{
//           formStr = `${formStr[0]}.add(${formStr[1]}).add(` + formStr.slice(2).join(').add(') + ')'
//         }
//         console.log(formStr)
//     return eval(`(function(x){return ${formStr}})`)
//   }



</script>